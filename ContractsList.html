<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <title>List of Contracts</title>

    <!-- Styles -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css"
    />

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.13.4/sorting/datetime-moment.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

    <style>
      body {
        font-size: 0.875rem;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .main-content {
        flex-grow: 1;
        padding: 20px;
      }

      /* Universal button styles */
      .btn {
        font-weight: 600 !important;
        border-radius: 25px !important;
        padding: 0.75rem 2rem !important;
        font-size: 1.1rem !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        border: none !important;
      }

      .btn:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
      }

      .btn:focus,
      .btn:active {
        transform: translateY(-1px) !important;
      }

      /* Small buttons */
      .btn-sm {
        padding: 0.25rem 0.75rem !important;
        font-size: 0.8rem !important;
        border-radius: 15px !important;
      }

      /* Primary buttons (главные действия) */
      .btn-primary,
      .btn-nav {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:hover,
      .btn-nav:hover {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:focus,
      .btn-primary:active,
      .btn-nav:focus,
      .btn-nav:active {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
      }

      /* Success buttons (создание/копирование) */
      .btn-success {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
      }

      .btn-success:hover {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
      }

      .btn-success:focus,
      .btn-success:active {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25) !important;
      }

      /* Danger buttons (удаление) */
      .btn-danger {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:hover {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:focus,
      .btn-danger:active {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
      }

      /* Outline buttons (secondary actions) */
      .btn-outline-primary {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        ) !important;
        color: #667eea !important;
        border: 2px solid #667eea !important;
      }

      .btn-outline-primary:hover {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
        border-color: #667eea !important;
      }

      .btn-outline-secondary {
        background: linear-gradient(
          135deg,
          rgba(108, 117, 125, 0.1) 0%,
          rgba(73, 80, 87, 0.1) 100%
        ) !important;
        color: #6c757d !important;
        border: 2px solid #6c757d !important;
      }

      .btn-outline-secondary:hover {
        background: linear-gradient(
          135deg,
          #6c757d 0%,
          #495057 100%
        ) !important;
        color: white !important;
        border-color: #6c757d !important;
      }

      .btn-outline-danger {
        background: linear-gradient(
          135deg,
          rgba(220, 53, 69, 0.1) 0%,
          rgba(176, 42, 55, 0.1) 100%
        ) !important;
        color: #dc3545 !important;
        border: 2px solid #dc3545 !important;
      }

      .btn-outline-danger:hover {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
        border-color: #dc3545 !important;
      }

      .btn-outline-success {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(32, 105, 43, 0.1) 100%
        ) !important;
        color: #28a745 !important;
        border: 2px solid #28a745 !important;
      }

      .btn-outline-success:hover {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
        border-color: #28a745 !important;
      }

      th,
      td {
        padding: 4px 8px !important;
      }

      table.dataTable {
        width: 100% !important;
      }

      thead input {
        width: 100%;
        box-sizing: border-box;
        padding: 4px;
      }

      /* Center table headers */
      #contractsTable thead th {
        text-align: center !important;
      }

      /* Link styling in table */
      .table-link {
        color: #667eea;
        text-decoration: none;
      }

      .table-link:hover {
        text-decoration: underline;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <!-- Top Navigation -->
    <?!= getNavigation(activePage) ?>

    <!-- Main Content -->
    <div class="main-content container-xl">
      <div class="mb-3 d-flex justify-content-start">
        <a
          href="<?= baseUrl ?>?page=ContractGenerator&mode=create"
          class="btn btn-nav"
        >
          Create new
        </a>
      </div>

      <h2 class="mb-4">List of Contracts</h2>

      <table
        id="contractsTable"
        class="display table table-bordered"
        style="width: 100%; min-width: 1200px; display: none"
      >
        <thead class="table-light">
          <tr>
            <th>Folder</th>
            <th>Contractor Name</th>
            <th>Our Company</th>
            <th>Service Type</th>
            <th>Cooperation Type</th>
            <th>Contract #</th>
            <th>Contract Date</th>
            <th>Document Type</th>
            <th>Attachment #</th>
            <th>Actions</th>
          </tr>
          <tr>
            <th></th>
            <th><input type="text" placeholder="Search Contractor" /></th>
            <th><input type="text" placeholder="Search Company" /></th>
            <th><input type="text" placeholder="Search Service" /></th>
            <th><input type="text" placeholder="Search Cooperation" /></th>
            <th><input type="text" placeholder="Search #" /></th>
            <th><input type="text" placeholder="Search Date" /></th>
            <th><input type="text" placeholder="Search Doc Type" /></th>
            <th><input type="text" placeholder="Search Attach #" /></th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <script>
        $(document).ready(function () {
          $.fn.dataTable.moment("DD/MM/YYYY");
          const table = $("#contractsTable").DataTable({
            dom: "lrtip",
            orderCellsTop: true,
            columnDefs: [
              {
                targets: 0, // Folder column
                className: "dt-body-center dt-head-center",
                orderable: false,
                width: "50px",
              },
              {
                targets: [1, 2, 3, 4, 5, 6, 7, 8],
                className: "dt-body-left dt-head-center",
              },
              {
                targets: 9, // Actions column
                className: "dt-body-center dt-head-center",
                orderable: false,
              },
            ],
          });

          new $.fn.dataTable.FixedHeader(table);

          // Column search
          $("#contractsTable thead tr:eq(1) th").each(function (i) {
            $("input", this).on("keyup change", function () {
              if (table.column(i).search() !== this.value) {
                table.column(i).search(this.value).draw();
              }
            });
          });

          // Load contracts data
          google.script.run
            .withSuccessHandler(function (data) {
              if (!Array.isArray(data) || data.length === 0) {
                table.clear().draw();
                document.getElementById("contractsTable").style.display = "";
                return;
              }

              data.forEach((row) => {
                // Create folder link if available
                const folderCell = row.folderLink
                  ? `<a href="${row.folderLink}" target="_blank" class="table-link" title="Open folder"><i class="bi bi-folder2-open"></i></a>`
                  : "";

                table.row.add([
                  folderCell,
                  row.contractorName || "",
                  row.ourCompany || "",
                  row.serviceType || "",
                  row.cooperationType || "",
                  row.contractNumber || "",
                  row.contractDate || "",
                  row.documentType || "",
                  row.attachmentNumber || "",
                  `<a href="<?= baseUrl ?>?page=ContractGenerator&id=${row.id}&mode=view" class="btn btn-sm btn-outline-primary">Open details</a>`,
                ]);
              });

              table.draw();
              document.getElementById("contractsTable").style.display = "";
            })
            .withFailureHandler(function (error) {
              console.error("Error loading contracts list:", error);
              // Show empty table on error
              document.getElementById("contractsTable").style.display = "";
            })
            .getContractList();
        });
      </script>
    </div>
    <!-- Close main-content -->

    <script>
      // Initialize Bootstrap tooltips
      document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });
    </script>
  </body>
</html>
