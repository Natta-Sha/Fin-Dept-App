<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Create Credit Note</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .form-label {
        font-weight: bold;
      }

      .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25) !important;
      }

      .btn-outline-danger:focus {
        box-shadow: none !important;
      }

      .icon-button {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: #6c757d;
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button i {
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button:hover i {
        color: #000 !important;
        transform: scale(1.2);
      }

      .icon-button:focus {
        outline: none;
        box-shadow: none;
      }

      .main-content {
        padding-top: 1rem;
      }

      /* Table column widths */
      #credit-note-table th:nth-child(1),
      #credit-note-table td:nth-child(1) {
        width: 10% !important;
        min-width: 100px;
      }
      #credit-note-table th:nth-child(2),
      #credit-note-table td:nth-child(2) {
        width: 50% !important;
      }
      #credit-note-table th:nth-child(3),
      #credit-note-table td:nth-child(3) {
        width: 20% !important;
      }
      #credit-note-table th:nth-child(4),
      #credit-note-table td:nth-child(4) {
        width: 20% !important;
      }
      #credit-note-table th:nth-child(5),
      #credit-note-table td:nth-child(5) {
        width: 5% !important;
        min-width: 50px;
      }

      /* Universal button styles */
      .btn {
        font-weight: 600 !important;
        border-radius: 25px !important;
        padding: 0.75rem 2rem !important;
        font-size: 1.1rem !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        border: none !important;
      }

      .btn:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
      }

      .btn:focus,
      .btn:active {
        transform: translateY(-1px) !important;
      }

      /* Small buttons */
      .btn-sm {
        padding: 0.25rem 0.75rem !important;
        font-size: 0.8rem !important;
        border-radius: 15px !important;
      }

      /* Add row button - compact */
      #add-row-btn {
        padding: 0.4rem 1rem !important;
        font-size: 0.9rem !important;
        border-radius: 20px !important;
      }

      /* Primary buttons (главные действия) */
      .btn-primary,
      .btn-nav {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:hover,
      .btn-nav:hover {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:focus,
      .btn-primary:active,
      .btn-nav:focus,
      .btn-nav:active {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
      }

      /* Success buttons (создание/копирование) */
      .btn-success {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
      }

      .btn-success:hover {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
      }

      .btn-success:focus,
      .btn-success:active {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25) !important;
      }

      /* Danger buttons (удаление) */
      .btn-danger {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:hover {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:focus,
      .btn-danger:active {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
      }

      /* Outline buttons (secondary actions) */
      .btn-outline-primary {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        ) !important;
        color: #667eea !important;
        border: 2px solid #667eea !important;
      }

      .btn-outline-primary:hover {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
        border-color: #667eea !important;
      }

      .btn-outline-secondary {
        background: linear-gradient(
          135deg,
          rgba(108, 117, 125, 0.1) 0%,
          rgba(73, 80, 87, 0.1) 100%
        ) !important;
        color: #6c757d !important;
        border: 2px solid #6c757d !important;
      }

      .btn-outline-secondary:hover {
        background: linear-gradient(
          135deg,
          #6c757d 0%,
          #495057 100%
        ) !important;
        color: white !important;
        border-color: #6c757d !important;
      }

      .btn-outline-danger {
        background: linear-gradient(
          135deg,
          rgba(220, 53, 69, 0.1) 0%,
          rgba(176, 42, 55, 0.1) 100%
        ) !important;
        color: #dc3545 !important;
        border: 2px solid #dc3545 !important;
      }

      .btn-outline-danger:hover {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
        border-color: #dc3545 !important;
      }

      .btn-outline-success {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(32, 105, 43, 0.1) 100%
        ) !important;
        color: #28a745 !important;
        border: 2px solid #28a745 !important;
      }

      .btn-outline-success:hover {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
        border-color: #28a745 !important;
      }
    </style>
    <!-- Bootstrap JS (для модальных окон) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <!-- Top Navigation -->
    <?!= getNavigation(activePage) ?>

    <!-- Main Content -->
    <div class="main-content container">
      <h2 id="page-title" class="mb-4">Create Credit Note</h2>

      <!-- Credit Note Form -->
      <form id="credit-note-form">
        <!-- Basic Information -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label"
              >Project Name <span class="text-danger">*</span></label
            >
            <input
              list="project_list"
              id="project_name"
              class="form-control"
              placeholder="Start typing to search..."
              required
            />
            <datalist id="project_list"></datalist>
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >Credit Note Number <span class="text-danger">*</span></label
            >
            <input
              id="credit_note_number"
              type="text"
              class="form-control"
              required
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Client Name</label>
            <p class="form-control-plaintext" id="client_name"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Client Address</label>
            <p class="form-control-plaintext" id="client_address"></p>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Client Number</label>
            <p class="form-control-plaintext" id="client_number"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Our Company</label>
            <p class="form-control-plaintext" id="our_company"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >Credit Note Date <span class="text-danger">*</span></label
            >
            <input
              id="credit_note_date"
              type="date"
              class="form-control"
              required
            />
          </div>
          <div class="col-md-3">
            <label
              class="form-label"
              for="exchange_rate"
              id="exchange_rate_label"
              >Exchange Rate</label
            >
            <p class="form-control-plaintext" id="exchange_rate_display"></p>
            <input
              id="exchange_rate"
              type="number"
              step="0.0001"
              class="form-control"
              value="1.0000"
              oninput="updateTotals()"
              style="display: none"
            />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Currency</label>
            <p class="form-control-plaintext" id="currency">$ (USD)</p>
          </div>
        </div>

        <!-- Comment -->
        <div class="mb-3">
          <label class="form-label">Comment</label>
          <input
            type="text"
            id="comment"
            class="form-control"
            placeholder="Optional comment for credit note"
          />
        </div>

        <!-- Items table -->
        <table class="table table-bordered" id="credit-note-table">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Description</th>
              <th>Period</th>
              <th>Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="credit-note-body">
            <tr>
              <td>
                <input type="text" class="form-control" value="1" readonly />
              </td>
              <td>
                <input
                  type="text"
                  class="form-control"
                  oninput="updateTotals()"
                />
              </td>
              <td>
                <input
                  type="text"
                  class="form-control"
                  oninput="updateTotals()"
                />
              </td>
              <td>
                <input
                  type="number"
                  class="form-control amount-input"
                  step="0.01"
                  oninput="updateTotals()"
                />
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>

        <button
          class="btn btn-outline-primary mb-3"
          onclick="addRow()"
          id="add-row-btn"
        >
          + Add Row
        </button>

        <!-- Totals -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Tax (%)</label>
            <p class="form-control-plaintext" id="tax">19</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Subtotal</label>
            <p class="form-control-plaintext" id="subtotal">0.00</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Total</label>
            <p class="form-control-plaintext" id="total">0.00</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Amount in EUR</label>
            <p class="form-control-plaintext" id="amount_in_eur"></p>
          </div>
        </div>
      </form>

      <div class="row mt-4 mb-4">
        <div
          class="col-md-12 d-flex justify-content-end gap-2"
          id="action-buttons"
        >
          <button
            id="generate-btn"
            class="btn btn-success"
            onclick="submitForm()"
          >
            Generate Credit Note
          </button>
          <button
            id="cancel-create-btn"
            class="btn btn-outline-secondary ms-2"
            onclick="safeNavigateToCreditNotesList()"
          >
            Cancel
          </button>
          <div
            id="spinner"
            class="spinner-border text-primary ms-3"
            style="display: none"
            role="status"
          >
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>

      <!-- Result area -->
      <div id="result"></div>
    </div>

    <script>
      let rowCount = 1;

      // Robust navigation back to credit notes list for both web-app and sidebar contexts
      function safeNavigateToCreditNotesList() {
        const target = "<?= baseUrl ?>?page=CreditNotesList";
        try {
          window.top.location.href = target;
          return;
        } catch (e) {}
        try {
          window.location.href = target;
          return;
        } catch (e2) {}
        if (
          typeof google !== "undefined" &&
          google.script &&
          google.script.host
        ) {
          google.script.host.close();
        }
      }

      // Fill project details from client database
      function fillProjectDetails(details) {
        window.currentProjectDetails = details;

        document.getElementById("client_name").textContent = details.clientName;
        document.getElementById("client_address").textContent =
          details.clientAddress;
        document.getElementById("client_number").textContent =
          details.clientNumber;
        document.getElementById("our_company").textContent =
          details.ourCompany || "";
        document.getElementById("tax").textContent = details.tax;

        const currencyMap = { $: "$ (USD)", "€": "€ (EUR)", "₴": "₴ (UAH)" };
        const currencySymbol = details.currency;
        document.getElementById("currency").textContent =
          currencyMap[currencySymbol] || currencySymbol;

        // Handle Exchange Rate field based on currency
        const exchangeInput = document.getElementById("exchange_rate");
        const exchangeDisplay = document.getElementById(
          "exchange_rate_display"
        );

        if (currencySymbol !== "$") {
          exchangeInput.style.display = "none";
          exchangeDisplay.textContent = "";
          document.getElementById("amount_in_eur").textContent = "";
        } else {
          exchangeInput.style.display = "block";
          exchangeInput.value = "1.0000";
          exchangeDisplay.innerHTML = `
    Exchange Rate (EUR 1 = USD ...)
    <a href="https://www.bundesbank.de/dynamic/action/en/statistics/time-series-databases/time-series-databases/745582/745582?dateSelect=2025&tsTab=0&listId=www_sdks_b01012_3&tsId=BBEX3.D.USD.EUR.BB.AC.000&id=0" target="_blank" class="ms-1 btn btn-link btn-sm p-0">Link</a>
  `;
        }

        updateTotals();
      }

      // Populate project names in datalist
      function populateProjectNames() {
        console.log("[populateProjectNames] running...");
        google.script.run
          .withSuccessHandler(function (projects) {
            validProjectNames = projects;
            const datalist = document.getElementById("project_list");
            datalist.innerHTML = "";
            projects.forEach((name) => {
              const opt = document.createElement("option");
              opt.value = name;
              datalist.appendChild(opt);
            });
            console.log(
              "[populateProjectNames] populated",
              projects.length,
              "projects"
            );
          })
          .withFailureHandler(function (error) {
            console.error("[populateProjectNames] failed:", error);
          })
          .getProjectNames();
      }

      // Global variable to store valid project names
      let validProjectNames = [];

      // Calculate totals function
      function updateTotals() {
        const amountInputs = document.querySelectorAll(
          "#credit-note-body input[type='number']"
        );
        let subtotal = 0;

        amountInputs.forEach((input) => {
          const value = parseFloat(input.value) || 0;
          subtotal += value;
        });

        const taxRate =
          parseFloat(document.getElementById("tax").textContent) || 0;
        const tax = (subtotal * taxRate) / 100;
        const total = subtotal + tax;

        document.getElementById("subtotal").textContent = subtotal.toFixed(2);
        document.getElementById("total").textContent = total.toFixed(2);

        // Calculate Amount in EUR based on currency
        const currency = document
          .getElementById("currency")
          .textContent.trim()
          .split(" ")[0];

        const amountInEurEl = document.getElementById("amount_in_eur");

        if (currency === "$") {
          const exchangeRate = parseFloat(
            document.getElementById("exchange_rate").value
          );
          amountInEurEl.textContent =
            exchangeRate > 0 ? (total / exchangeRate).toFixed(2) : "0.00";
        } else {
          amountInEurEl.textContent = "";
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        // Populate project names
        populateProjectNames();

        // Add event listener for project name changes
        document
          .getElementById("project_name")
          .addEventListener("change", function () {
            const value = this.value.trim();
            if (validProjectNames.includes(value)) {
              google.script.run
                .withSuccessHandler(fillProjectDetails)
                .withFailureHandler(function (error) {
                  console.error("Failed to load project details:", error);
                })
                .getProjectDetails(value);
            }
          });

        // Add event listeners for all existing table inputs
        document
          .querySelectorAll("#credit-note-body input")
          .forEach(function (input) {
            if (input.type !== "text" || !input.readOnly) {
              input.addEventListener("input", updateTotals);
            }
          });
      });

      // Add row function
      function addRow() {
        const tbody = document.getElementById("credit-note-body");
        const rowNumber = tbody.rows.length + 1;
        const row = tbody.insertRow();

        // Create cells and inputs like in invoices
        for (let i = 0; i < 4; i++) {
          const cell = row.insertCell();
          const input = document.createElement("input");
          input.className = "form-control";
          input.type = i === 3 ? "number" : "text";
          if (i === 0) {
            input.value = rowNumber;
            input.readOnly = true;
          }
          if (i === 3) {
            input.classList.add("amount-input");
            input.step = "0.01";
          }
          // input.oninput = updateTotals; // Temporarily disabled
          cell.appendChild(input);
        }

        // Add delete button cell
        const deleteCell = row.insertCell();
        deleteCell.innerHTML = `
          <button type="button" class="icon-button" onclick="removeRow(this)" title="Delete row">
            <i class="bi bi-trash"></i>
          </button>
        `;
      }

      // Remove row function
      function removeRow(button) {
        const row = button.closest("tr");
        const tbody = document.getElementById("credit-note-body");
        if (tbody.children.length > 1) {
          row.remove();
          updateRowNumbers();
          updateTotals();
        }
      }

      // Update row numbers
      function updateRowNumbers() {
        const rows = document.querySelectorAll("#credit-note-body tr");
        rows.forEach((row, index) => {
          const numberInput = row.querySelector("input[type='text']");
          if (numberInput) {
            numberInput.value = index + 1;
          }
        });
      }

      // Form submission
      function submitForm() {
        const projectValue = document
          .getElementById("project_name")
          .value.trim();

        // Check if we need to load project details first
        if (!window.currentProjectDetails && projectValue) {
          document.getElementById("generate-btn").disabled = true;
          document.getElementById("spinner").style.display = "inline-block";

          google.script.run
            .withSuccessHandler(function (details) {
              window.currentProjectDetails = details;
              console.log("Project details loaded:", details);
              // Now submit the form with the loaded details
              submitFormWithData();
            })
            .withFailureHandler(function (error) {
              console.error("Failed to load project details:", error);
              alert("Failed to load project details. Please try again.");
              document.getElementById("generate-btn").disabled = false;
              document.getElementById("spinner").style.display = "none";
            })
            .getProjectDetails(projectValue);
          return;
        }

        // If project details are already loaded, submit directly
        submitFormWithData();
      }

      function submitFormWithData() {
        const projectValue = document
          .getElementById("project_name")
          .value.trim();

        const data = {
          projectName: projectValue,
          creditNoteNumber: document
            .getElementById("credit_note_number")
            .value.trim(),
          clientName: document.getElementById("client_name").textContent.trim(),
          clientAddress: document
            .getElementById("client_address")
            .textContent.trim(),
          clientNumber: document
            .getElementById("client_number")
            .textContent.trim(),
          creditNoteDate: document
            .getElementById("credit_note_date")
            .value.trim(),
          tax: document.getElementById("tax").textContent.trim(),
          subtotal: document.getElementById("subtotal").textContent.trim(),
          total: document.getElementById("total").textContent.trim(),
          exchangeRate: document.getElementById("exchange_rate").value.trim(),
          currency: document
            .getElementById("currency")
            .textContent.trim()
            .split(" ")[0],
          amountInEUR: document
            .getElementById("amount_in_eur")
            .textContent.trim(),
          ourCompany: document.getElementById("our_company").textContent.trim(),
          comment: document.getElementById("comment").value.trim(),
          items: [],
        };

        // Calculate tax amount
        const subtotal = parseFloat(data.subtotal) || 0;
        const taxRate = parseFloat(data.tax) || 0;
        data.taxAmount = ((subtotal * taxRate) / 100).toFixed(2);

        // Collect items from table
        const tbody = document.getElementById("credit-note-body");
        for (let row of tbody.rows) {
          const inputs = row.getElementsByTagName("input");
          const rowData = Array.from(inputs).map((i) => i.value.trim());
          data.items.push(rowData);
        }

        console.log(
          "Data being sent to server:",
          JSON.stringify(data, null, 2)
        );

        // Enable spinner and disable button + form
        document.getElementById("generate-btn").disabled = true;
        document.getElementById("spinner").style.display = "inline-block";
        document.getElementById("result").innerHTML = "";

        google.script.run
          .withFailureHandler(function (error) {
            document.getElementById("spinner").style.display = "none";
            document.getElementById("generate-btn").disabled = false;
            alert(
              "An error occurred: " +
                error.message +
                "\n\nPlease check the browser console for more details."
            );
            console.error("Server-side call failed:", error);
          })
          .withSuccessHandler(function (result) {
            document.getElementById("spinner").style.display = "none";
            document.getElementById("result").innerHTML = `
              <div class="alert alert-success mt-4">
                <strong>Credit Note saved successfully!</strong><br>
                <small class="text-muted">Document creation will be implemented later.</small>
              </div>
              <div class="row mt-4">
                <div class="col-md-12 d-flex justify-content-end gap-2">
                  <button class="btn btn-primary px-5 fw-bold" onclick="safeNavigateToCreditNotesList()">Back to the list</button>
                </div>
              </div>
            `;

            // Hide generate button after success
            document.getElementById("generate-btn").style.display = "none";
            document.getElementById("cancel-create-btn").style.display = "none";
          })
          .processCreditNoteForm(data);
      }

      // Initialize tooltips and event listeners
      document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Add event listeners for amount inputs
        document.addEventListener("change", function (e) {
          if (e.target.classList.contains("amount-input")) {
            updateTotals();
          }
        });
      });
    </script>
  </body>
</html>
