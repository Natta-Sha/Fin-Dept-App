<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Create Credit Note</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .form-label {
        font-weight: bold;
      }

      .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25) !important;
      }

      .btn-outline-danger:focus {
        box-shadow: none !important;
      }

      .icon-button {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: #6c757d;
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button i {
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button:hover i {
        color: #000 !important;
        transform: scale(1.2);
      }

      .icon-button:focus {
        outline: none;
        box-shadow: none;
      }

      .main-content {
        padding-top: 1rem;
      }

      /* Table column widths */
      #credit-note-table th:nth-child(1),
      #credit-note-table td:nth-child(1) {
        width: 10% !important;
        min-width: 100px;
      }
      #credit-note-table th:nth-child(2),
      #credit-note-table td:nth-child(2) {
        width: 50% !important;
      }
      #credit-note-table th:nth-child(3),
      #credit-note-table td:nth-child(3) {
        width: 20% !important;
      }
      #credit-note-table th:nth-child(4),
      #credit-note-table td:nth-child(4) {
        width: 20% !important;
      }
      #credit-note-table th:nth-child(5),
      #credit-note-table td:nth-child(5) {
        width: 5% !important;
        min-width: 50px;
      }

      /* Universal button styles */
      .btn {
        font-weight: 600 !important;
        border-radius: 25px !important;
        padding: 0.75rem 2rem !important;
        font-size: 1.1rem !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        border: none !important;
      }

      .btn:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
      }

      .btn:focus,
      .btn:active {
        transform: translateY(-1px) !important;
      }

      /* Small buttons */
      .btn-sm {
        padding: 0.25rem 0.75rem !important;
        font-size: 0.8rem !important;
        border-radius: 15px !important;
      }

      /* Add row button - compact */
      #add-row-btn {
        padding: 0.4rem 1rem !important;
        font-size: 0.9rem !important;
        border-radius: 20px !important;
      }

      /* Primary buttons (главные действия) */
      .btn-primary,
      .btn-nav {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:hover,
      .btn-nav:hover {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:focus,
      .btn-primary:active,
      .btn-nav:focus,
      .btn-nav:active {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
      }

      /* Success buttons (создание/копирование) */
      .btn-success {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
      }

      .btn-success:hover {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
      }

      .btn-success:focus,
      .btn-success:active {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25) !important;
      }

      /* Danger buttons (удаление) */
      .btn-danger {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:hover {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:focus,
      .btn-danger:active {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
      }

      /* Outline buttons (secondary actions) */
      .btn-outline-primary {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        ) !important;
        color: #667eea !important;
        border: 2px solid #667eea !important;
      }

      .btn-outline-primary:hover {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
        border-color: #667eea !important;
      }

      .btn-outline-secondary {
        background: linear-gradient(
          135deg,
          rgba(108, 117, 125, 0.1) 0%,
          rgba(73, 80, 87, 0.1) 100%
        ) !important;
        color: #6c757d !important;
        border: 2px solid #6c757d !important;
      }

      .btn-outline-secondary:hover {
        background: linear-gradient(
          135deg,
          #6c757d 0%,
          #495057 100%
        ) !important;
        color: white !important;
        border-color: #6c757d !important;
      }

      .btn-outline-danger {
        background: linear-gradient(
          135deg,
          rgba(220, 53, 69, 0.1) 0%,
          rgba(176, 42, 55, 0.1) 100%
        ) !important;
        color: #dc3545 !important;
        border: 2px solid #dc3545 !important;
      }

      .btn-outline-danger:hover {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
        border-color: #dc3545 !important;
      }

      .btn-outline-success {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(32, 105, 43, 0.1) 100%
        ) !important;
        color: #28a745 !important;
        border: 2px solid #28a745 !important;
      }

      .btn-outline-success:hover {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
        border-color: #28a745 !important;
      }
    </style>
    <!-- Bootstrap JS (для модальных окон) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <!-- Top Navigation -->
    <?!= getNavigation(activePage) ?>

    <!-- Main Content -->
    <div class="main-content container py-4">
      <h2 id="page-title" class="mb-4">Create Credit Note</h2>

      <!-- Credit Note Form -->
      <form id="credit-note-form">
        <!-- Basic Information -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label"
              >Project Name <span class="text-danger">*</span></label
            >
            <input
              list="project_list"
              id="project_name"
              class="form-control"
              placeholder="Start typing to search..."
            />
            <datalist id="project_list"></datalist>
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >Credit Note Number <span class="text-danger">*</span></label
            >
            <input id="credit_note_number" type="text" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Client Name</label>
            <p class="form-control-plaintext" id="client_name"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Client Address</label>
            <p class="form-control-plaintext" id="client_address"></p>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Client Number</label>
            <p class="form-control-plaintext" id="client_number"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Our Company</label>
            <p class="form-control-plaintext" id="our_company"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >Credit Note Date <span class="text-danger">*</span></label
            >
            <input id="credit_note_date" type="date" class="form-control" />
          </div>
          <div class="col-md-3">
            <label
              class="form-label"
              for="exchange_rate"
              id="exchange_rate_label"
              >Exchange Rate</label
            >
            <p class="form-control-plaintext" id="exchange_rate_display"></p>
            <input
              id="exchange_rate"
              type="number"
              step="0.0001"
              class="form-control"
              value="1.0000"
              oninput="updateTotals()"
              style="display: none"
            />
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Currency</label>
            <p class="form-control-plaintext" id="currency">$ (USD)</p>
          </div>
        </div>

        <!-- Comment -->
        <div class="mb-3">
          <label class="form-label">Comment</label>
          <p
            class="form-control-plaintext"
            id="comment-display"
            style="display: none"
          ></p>
          <input
            type="text"
            id="comment"
            class="form-control"
            placeholder="Optional comment for credit note"
          />
        </div>

        <!-- Items table -->
        <table class="table table-bordered" id="credit-note-table">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Description</th>
              <th>Period</th>
              <th>Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="credit-note-body">
            <tr>
              <td>
                <input type="text" class="form-control" value="1" readonly />
              </td>
              <td>
                <input type="text" class="form-control" />
              </td>
              <td>
                <input type="text" class="form-control" />
              </td>
              <td>
                <input
                  type="number"
                  class="form-control amount-input"
                  step="0.01"
                  oninput="updateTotals()"
                />
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>

        <button
          type="button"
          class="btn btn-outline-primary mb-3"
          onclick="addRow()"
          id="add-row-btn"
        >
          + Add Row
        </button>

        <!-- Totals -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Tax (%)</label>
            <p class="form-control-plaintext" id="tax">19</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Subtotal</label>
            <p class="form-control-plaintext" id="subtotal">0.00</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Total</label>
            <p class="form-control-plaintext" id="total">0.00</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Amount in EUR</label>
            <p class="form-control-plaintext" id="amount_in_eur"></p>
          </div>
        </div>
      </form>

      <div class="row mt-4 mb-4">
        <div
          class="col-md-12 d-flex justify-content-end gap-2"
          id="action-buttons"
        >
          <button
            id="generate-btn"
            class="btn btn-success"
            onclick="submitForm()"
          >
            Generate Credit Note
          </button>
          <button
            id="cancel-create-btn"
            class="btn btn-outline-secondary ms-2"
            onclick="safeNavigateToCreditNotesList()"
          >
            Cancel
          </button>
          <div
            id="spinner"
            class="spinner-border text-primary ms-3"
            style="display: none"
            role="status"
          >
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>

      <!-- View mode bottom actions -->
      <div id="view-bottom-btn-container" style="display: none">
        <div class="row mt-4">
          <div class="col-md-12 d-flex justify-content-end gap-2">
            <button
              id="view-back-btn"
              class="btn btn-outline-primary px-5 fw-bold"
            >
              Back
            </button>
          </div>
        </div>
      </div>

      <!-- Delete mode bottom actions -->
      <div id="delete-bottom-btn-container" style="display: none">
        <div class="row mt-4">
          <div
            class="col-md-12 d-flex justify-content-end gap-2 align-items-center"
          >
            <button id="delete-bottom-btn" class="btn btn-danger px-5 fw-bold">
              Delete
            </button>
            <button
              id="delete-cancel-btn"
              class="btn btn-outline-secondary px-5 fw-bold"
            >
              Cancel
            </button>
            <div
              id="delete-bottom-spinner"
              class="spinner-border text-danger ms-2"
              style="display: none"
              role="status"
            >
              <span class="visually-hidden">Deleting...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Result area -->
      <div id="result"></div>
    </div>

    <script>
      let rowCount = 1;

      // Robust navigation back to credit notes list for both web-app and sidebar contexts
      function safeNavigateToCreditNotesList() {
        const target = "<?= baseUrl ?>?page=CreditNotesList";
        try {
          window.top.location.href = target;
          return;
        } catch (e) {}
        try {
          window.location.href = target;
          return;
        } catch (e2) {}
        if (
          typeof google !== "undefined" &&
          google.script &&
          google.script.host
        ) {
          google.script.host.close();
        }
      }

      // Fill project details from client database
      function fillProjectDetails(details) {
        console.log("fillProjectDetails called with:", details);
        window.currentProjectDetails = details;

        const clientNameEl = document.getElementById("client_name");
        const clientAddressEl = document.getElementById("client_address");
        const clientNumberEl = document.getElementById("client_number");

        console.log("client_name element:", clientNameEl);
        console.log("client_address element:", clientAddressEl);
        console.log("client_number element:", clientNumberEl);

        console.log("Setting client_name to:", details.clientName);
        if (clientNameEl) clientNameEl.textContent = details.clientName;
        console.log(
          "After setting client_name:",
          clientNameEl ? clientNameEl.textContent : "element not found"
        );

        console.log("Setting client_address to:", details.clientAddress);
        if (clientAddressEl)
          clientAddressEl.textContent = details.clientAddress;
        console.log(
          "After setting client_address:",
          clientAddressEl ? clientAddressEl.textContent : "element not found"
        );

        console.log("Setting client_number to:", details.clientNumber);
        if (clientNumberEl) clientNumberEl.textContent = details.clientNumber;
        console.log(
          "After setting client_number:",
          clientNumberEl ? clientNumberEl.textContent : "element not found"
        );
        document.getElementById("our_company").textContent =
          details.ourCompany || "";
        document.getElementById("tax").textContent = details.tax;

        const currencyMap = { $: "$ (USD)", "€": "€ (EUR)", "₴": "₴ (UAH)" };
        const currencySymbol = details.currency;
        document.getElementById("currency").textContent =
          currencyMap[currencySymbol] || currencySymbol;

        // Handle Exchange Rate field based on currency
        const exchangeInput = document.getElementById("exchange_rate");
        const exchangeDisplay = document.getElementById(
          "exchange_rate_display"
        );

        if (currencySymbol !== "$") {
          exchangeInput.style.display = "none";
          exchangeDisplay.textContent = "";
          document.getElementById("amount_in_eur").textContent = "";
        } else {
          exchangeInput.style.display = "block";
          exchangeInput.value = "1.0000";
          exchangeDisplay.innerHTML = `
    Exchange Rate (EUR 1 = USD ...)
    <a href="https://www.bundesbank.de/dynamic/action/en/statistics/time-series-databases/time-series-databases/745582/745582?dateSelect=2025&tsTab=0&listId=www_sdks_b01012_3&tsId=BBEX3.D.USD.EUR.BB.AC.000&id=0" target="_blank" class="ms-1 btn btn-link btn-sm p-0">Link</a>
  `;
        }

        updateTotals();
      }

      // Format date for input type="date" (same as in InvoiceGenerator)
      function formatInputDate(dateVal) {
        if (typeof dateVal === "string" && dateVal.includes("/")) {
          const [dd, mm, yyyy] = dateVal.split("/");
          return `${yyyy}-${mm.padStart(2, "0")}-${dd.padStart(2, "0")}`;
        }
        return dateVal;
      }

      // Render saved credit note data for view mode
      function renderSavedDataRaw(data) {
        console.log("renderSavedDataRaw called with data:", data);
        console.log("renderSavedDataRaw: data.projectName =", data.projectName);
        console.log(
          "renderSavedDataRaw: data.creditNoteDate =",
          data.creditNoteDate
        );
        console.log("renderSavedDataRaw: data.items =", data.items);
        console.log(
          "renderSavedDataRaw: data.items length =",
          data.items.length
        );
        if (data.items && data.items.length > 0) {
          console.log("renderSavedDataRaw: first item =", data.items[0]);
          console.log(
            "renderSavedDataRaw: first item length =",
            data.items[0].length
          );
        }
        console.log("renderSavedDataRaw: data.subtotal =", data.subtotal);
        console.log("renderSavedDataRaw: data.total =", data.total);

        // Fill basic fields with null checks
        const projectNameEl = document.getElementById("project_name");
        if (projectNameEl) projectNameEl.value = data.projectName || "";

        const creditNoteNumberEl =
          document.getElementById("credit_note_number");
        if (creditNoteNumberEl)
          creditNoteNumberEl.value = data.creditNoteNumber || "";

        const clientNameEl = document.getElementById("client_name");
        if (clientNameEl) clientNameEl.textContent = data.clientName || "";

        const clientAddressEl = document.getElementById("client_address");
        if (clientAddressEl)
          clientAddressEl.textContent = data.clientAddress || "";

        const clientNumberEl = document.getElementById("client_number");
        if (clientNumberEl)
          clientNumberEl.textContent = data.clientNumber || "";

        const ourCompanyEl = document.getElementById("our_company");
        if (ourCompanyEl) ourCompanyEl.textContent = data.ourCompany || "";

        const taxEl = document.getElementById("tax");
        if (taxEl) taxEl.textContent = data.tax || "0";

        const currencyMap = { $: "$ (USD)", "€": "€ (EUR)", "₴": "₴ (UAH)" };
        const currencyEl = document.getElementById("currency");
        if (currencyEl)
          currencyEl.textContent =
            currencyMap[data.currency] || data.currency || "";

        const bankDetails1El = document.getElementById("bank_details_1");
        if (bankDetails1El)
          bankDetails1El.textContent = data.bankDetails1 || "";

        const bankDetails2El = document.getElementById("bank_details_2");
        if (bankDetails2El)
          bankDetails2El.textContent = data.bankDetails2 || "";

        // Format and set date
        if (data.creditNoteDate) {
          const creditNoteDateEl = document.getElementById("credit_note_date");
          if (creditNoteDateEl) {
            creditNoteDateEl.value = formatInputDate(data.creditNoteDate);
          }
        }

        // Handle exchange rate (same logic as InvoiceGenerator)
        if (data.currency === "$") {
          const exchangeRateEl = document.getElementById("exchange_rate");
          if (exchangeRateEl) {
            exchangeRateEl.style.display = "block";
            exchangeRateEl.value = data.exchangeRate || "1.0000";
          }
          const amountInEUREl = document.getElementById("amount_in_eur");
          if (amountInEUREl) {
            amountInEUREl.textContent = data.amountInEUR || "";
          }
        } else {
          const exchangeRateEl = document.getElementById("exchange_rate");
          if (exchangeRateEl) {
            exchangeRateEl.style.display = "none";
          }
          const exchangeRateDisplayEl = document.getElementById(
            "exchange_rate_display"
          );
          if (exchangeRateDisplayEl) {
            exchangeRateDisplayEl.textContent = "";
          }
          const amountInEUREl = document.getElementById("amount_in_eur");
          if (amountInEUREl) {
            amountInEUREl.textContent = "";
          }
        }

        const commentDisplayEl = document.getElementById("comment-display");
        if (commentDisplayEl) {
          commentDisplayEl.textContent = data.comment || "";
        }

        // Add rows to the table (same logic as InvoiceGenerator)
        const tbody = document.getElementById("credit-note-body");
        if (tbody) {
          tbody.innerHTML = ""; // Clear

          data.items.forEach((item, index) => {
            const row = document.createElement("tr");

            // First column: Row number (index + 1)
            const cell1 = document.createElement("td");
            const input1 = document.createElement("input");
            input1.type = "text";
            input1.className = "form-control";
            input1.value = (index + 1).toString(); // Row number: 1, 2, 3, etc.
            input1.disabled = true;
            cell1.appendChild(input1);
            row.appendChild(cell1);

            // Second column: Description (item[1])
            const cell2 = document.createElement("td");
            const input2 = document.createElement("input");
            input2.type = "text";
            input2.className = "form-control";
            input2.value = item[1] || ""; // Description
            input2.disabled = true;
            cell2.appendChild(input2);
            row.appendChild(cell2);

            // Third column: Period (item[2])
            const cell3 = document.createElement("td");
            const input3 = document.createElement("input");
            input3.type = "text";
            input3.className = "form-control";
            input3.value = item[2] || ""; // Period
            input3.disabled = true;
            cell3.appendChild(input3);
            row.appendChild(cell3);

            // Fourth column: Amount (item[3])
            const cell4 = document.createElement("td");
            const input4 = document.createElement("input");
            input4.type = "text";
            input4.className = "form-control amount";
            input4.value = item[3] || ""; // Amount
            input4.disabled = true;
            cell4.appendChild(input4);
            row.appendChild(cell4);

            row.appendChild(document.createElement("td")); // пустая ячейка под кнопки
            tbody.appendChild(row);
          });
        }

        // Update totals (same logic as InvoiceGenerator)
        const subtotalEl = document.getElementById("subtotal");
        if (subtotalEl) {
          subtotalEl.innerText = data.subtotal || "0.00";
        }
        const totalEl = document.getElementById("total");
        if (totalEl) {
          totalEl.innerText = data.total || "0.00";
        }

        console.log("renderSavedDataRaw completed");
        const finalSubtotalEl = document.getElementById("subtotal");
        console.log(
          "renderSavedDataRaw: Final subtotal element text =",
          finalSubtotalEl ? finalSubtotalEl.innerText : "element not found"
        );
        const finalTotalEl = document.getElementById("total");
        console.log(
          "renderSavedDataRaw: Final total element text =",
          finalTotalEl ? finalTotalEl.innerText : "element not found"
        );
        const finalDateEl = document.getElementById("credit_note_date");
        console.log(
          "renderSavedDataRaw: Final date input value =",
          finalDateEl ? finalDateEl.value : "element not found"
        );
      }

      // Populate project names in datalist
      function populateProjectNames() {
        console.log("[populateProjectNames] running...");
        google.script.run
          .withSuccessHandler(function (projects) {
            console.log("[populateProjectNames] received projects:", projects);
            validProjectNames = projects;
            console.log(
              "[populateProjectNames] validProjectNames set to:",
              validProjectNames
            );
            const datalist = document.getElementById("project_list");
            datalist.innerHTML = "";
            projects.forEach((name) => {
              const opt = document.createElement("option");
              opt.value = name;
              datalist.appendChild(opt);
            });
            console.log(
              "[populateProjectNames] populated",
              projects.length,
              "projects"
            );
            console.log(
              "[populateProjectNames] CityFALCON included?",
              projects.includes("CityFALCON")
            );

            // Add project selection handlers AFTER projects are loaded
            setupProjectSelectionHandlers();
          })
          .withFailureHandler(function (error) {
            console.error("[populateProjectNames] failed:", error);
          })
          .getProjectNames();
      }

      // Global variable to store valid project names
      let validProjectNames = [];

      // Get parameters from server-side template variables
      const creditNoteId = "<?= creditNoteId ?>" || "";
      const mode = "<?= mode ?>" || "";

      console.log("Template parameters:", {
        creditNoteId: creditNoteId,
        mode: mode,
        fullUrl: window.location.href,
        search: window.location.search,
      });

      // Debug: Check if we're in view or delete mode
      if (mode === "view") {
        console.log("VIEW MODE DETECTED - Setting up view mode immediately");
        // Set up view mode immediately
        document.addEventListener("DOMContentLoaded", function () {
          console.log("DOMContentLoaded - Setting up view mode");
          document.getElementById("page-title").textContent =
            "Credit Note - View";
          document.getElementById("view-bottom-btn-container").style.display =
            "block";
          document.getElementById("generate-btn").style.display = "none";
          document.getElementById("cancel-create-btn").style.display = "none";

          // Hide add row button
          const addRowBtn = document.getElementById("add-row-btn");
          if (addRowBtn) addRowBtn.style.display = "none";

          // Disable all form inputs
          document
            .querySelectorAll("input, textarea, select")
            .forEach(function (element) {
              element.disabled = true;
            });

          // Add Back button handler
          const viewBackBtn = document.getElementById("view-back-btn");
          if (viewBackBtn) {
            viewBackBtn.addEventListener("click", function () {
              safeNavigateToCreditNotesList();
            });
          }
        });
      } else if (mode === "delete") {
        console.log(
          "DELETE MODE DETECTED - Setting up delete mode immediately"
        );
        // Set up delete mode immediately
        document.addEventListener("DOMContentLoaded", function () {
          console.log("DOMContentLoaded - Setting up delete mode");
          document.getElementById("page-title").textContent =
            "Credit Note - Delete";
          document.getElementById("delete-bottom-btn-container").style.display =
            "block";
          document.getElementById("generate-btn").style.display = "none";
          document.getElementById("cancel-create-btn").style.display = "none";

          // Hide add row button
          const addRowBtn = document.getElementById("add-row-btn");
          if (addRowBtn) addRowBtn.style.display = "none";

          // Disable all form inputs
          document
            .querySelectorAll("input, textarea, select")
            .forEach(function (element) {
              element.disabled = true;
            });

          // Add Delete button handler
          const deleteBtn = document.getElementById("delete-bottom-btn");
          if (deleteBtn) {
            deleteBtn.addEventListener("click", function () {
              // Show spinner
              const bottomSpin = document.getElementById(
                "delete-bottom-spinner"
              );
              if (bottomSpin) bottomSpin.style.display = "inline-block";

              // Disable button
              this.disabled = true;

              // Call delete function
              google.script.run
                .withSuccessHandler(function (result) {
                  if (result.success) {
                    // Show success message
                    let message = "Credit note deleted successfully!";
                    if (result.note) {
                      message += " " + result.note;
                    }
                    alert(message);

                    // Navigate back to list
                    safeNavigateToCreditNotesList();
                  } else {
                    alert(
                      "Error deleting credit note: " +
                        (result.message || "Unknown error")
                    );
                    // Re-enable button
                    document.getElementById(
                      "delete-bottom-btn"
                    ).disabled = false;
                    const bottomSpin2 = document.getElementById(
                      "delete-bottom-spinner"
                    );
                    if (bottomSpin2) bottomSpin2.style.display = "none";
                  }
                })
                .withFailureHandler(function (error) {
                  alert("Error deleting credit note: " + error.message);
                  // Re-enable button
                  document.getElementById("delete-bottom-btn").disabled = false;
                  const bottomSpin3 = document.getElementById(
                    "delete-bottom-spinner"
                  );
                  if (bottomSpin3) bottomSpin3.style.display = "none";
                })
                .deleteCreditNoteById(creditNoteId);
            });
          }

          // Add Cancel button handler for delete mode
          const deleteCancelBtn = document.getElementById("delete-cancel-btn");
          if (deleteCancelBtn) {
            deleteCancelBtn.addEventListener("click", function () {
              safeNavigateToCreditNotesList();
            });
          }
        });
      }

      // Setup project selection handlers (called after projects are loaded)
      function setupProjectSelectionHandlers() {
        function handleProjectSelection() {
          const value = this.value.trim();
          console.log("Project selection event triggered, value:", value);
          if (validProjectNames.includes(value)) {
            console.log("Valid project selected, loading details...");
            google.script.run
              .withSuccessHandler(fillProjectDetails)
              .withFailureHandler(function (error) {
                console.error("Failed to load project details:", error);
              })
              .getProjectDetails(value);
          } else {
            console.log(
              "Project not in valid list:",
              validProjectNames.includes(value)
            );
          }
        }

        const projectNameField = document.getElementById("project_name");
        projectNameField.addEventListener("change", handleProjectSelection);
        projectNameField.addEventListener("input", handleProjectSelection);
        projectNameField.addEventListener("blur", handleProjectSelection);
        console.log("Project selection handlers setup complete");
      }

      // Function to disable/enable form inputs
      function setFormInputsDisabled(isDisabled) {
        try {
          document.querySelectorAll("input, textarea").forEach((el) => {
            el.disabled = isDisabled;
          });
          const addRowBtnEl = document.getElementById("add-row-btn");
          if (addRowBtnEl) addRowBtnEl.disabled = isDisabled;

          // Hide/show delete buttons based on form state
          if (isDisabled) {
            document.body.classList.add("form-submitted");
          } else {
            document.body.classList.remove("form-submitted");
          }
        } catch (_) {}
      }

      // Calculate totals function
      function updateTotals() {
        const tbody = document.getElementById("credit-note-body");
        let subtotal = 0;

        for (let row of tbody.rows) {
          const inputs = row.getElementsByTagName("input");
          const amountCell = inputs[3]; // Amount is the 4th input (index 3)
          subtotal += parseFloat(amountCell.value) || 0;
        }

        document.getElementById("subtotal").innerText = subtotal.toFixed(2);

        const tax = parseFloat(document.getElementById("tax").textContent) || 0;
        const total = subtotal + (subtotal * tax) / 100;
        document.getElementById("total").innerText = total.toFixed(2);

        // Calculate Amount in EUR based on currency
        const currency = document
          .getElementById("currency")
          .textContent.trim()
          .split(" ")[0];

        const amountInEurEl = document.getElementById("amount_in_eur");

        if (currency === "$") {
          const exchangeRate = parseFloat(
            document.getElementById("exchange_rate").value
          );
          amountInEurEl.innerText =
            exchangeRate > 0 ? (total / exchangeRate).toFixed(2) : "0.00";
        } else {
          amountInEurEl.innerText = "";
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOMContentLoaded - Starting initialization");
        console.log("Current mode:", mode, "creditNoteId:", creditNoteId);

        // Populate project names
        populateProjectNames();

        // Add event listeners for all existing table inputs
        document
          .querySelectorAll("#credit-note-body input")
          .forEach(function (input) {
            if (input.type !== "text" || !input.readOnly) {
              input.addEventListener("input", updateTotals);
            }
          });

        // Handle view/edit modes
        if (creditNoteId) {
          console.log(
            "Loading credit note data for ID:",
            creditNoteId,
            "mode:",
            mode
          );
          google.script.run
            .withSuccessHandler(function (data) {
              console.log("Loaded credit note data:", data);
              console.log("Data type:", typeof data);
              console.log("Data keys:", Object.keys(data || {}));
              console.log("Project name:", data?.projectName);
              console.log("Credit note date:", data?.creditNoteDate);
              console.log("Items:", data?.items);
              console.log("Subtotal:", data?.subtotal);
              console.log("Total:", data?.total);

              if (!data || !data.projectName) {
                console.error("Invalid credit note data received:", data);
                alert(
                  "Error loading credit note data. The credit note may have invalid data in the database."
                );
                window.location.href = "?page=CreditNotesList";
                return;
              }
              if (["view", "delete"].includes(mode)) {
                renderSavedDataRaw(data);
              } else {
                // For edit/copy modes, we'll handle differently
                renderSavedDataRaw(data);
              }

              // Set up the page based on mode AFTER data is loaded
              console.log("Setting up page for mode:", mode);
              if (mode === "view") {
                console.log("Setting up view mode...");
                document.getElementById("page-title").textContent =
                  "Credit Note - View";
                document.getElementById(
                  "view-bottom-btn-container"
                ).style.display = "block";
                document.getElementById("generate-btn").style.display = "none";
                document.getElementById("cancel-create-btn").style.display =
                  "none";

                // Add Back button handler for view mode
                const viewBackBtn = document.getElementById("view-back-btn");
                if (viewBackBtn) {
                  viewBackBtn.addEventListener("click", function () {
                    safeNavigateToCreditNotesList();
                  });
                }

                // Hide add row button in view mode
                const addRowBtn = document.getElementById("add-row-btn");
                if (addRowBtn) addRowBtn.style.display = "none";

                // Disable all form inputs in view mode
                document
                  .querySelectorAll("input, textarea, select")
                  .forEach(function (element) {
                    element.disabled = true;
                  });

                // Show comment as plaintext, hide input to avoid placeholder
                const commentInputEl = document.getElementById("comment");
                const commentDisplayEl =
                  document.getElementById("comment-display");
                if (commentInputEl && commentDisplayEl) {
                  commentDisplayEl.style.display = "block";
                  commentInputEl.style.display = "none";
                }
              }
            })
            .withFailureHandler(function (error) {
              console.error("Failed to load credit note data:", error);
              alert("Failed to load credit note data.");
              window.location.href = "?page=CreditNotesList";
            })
            .getCreditNoteDataById(creditNoteId);
        } else {
          // Check if project is already selected and load its details
          const selectedProject = document
            .getElementById("project_name")
            .value.trim();
          if (selectedProject && validProjectNames.includes(selectedProject)) {
            google.script.run
              .withSuccessHandler(fillProjectDetails)
              .getProjectDetails(selectedProject);
          }
        }
      });

      // Add row function
      function addRow() {
        const tbody = document.getElementById("credit-note-body");
        const rowNumber = tbody.rows.length + 1;
        const row = tbody.insertRow();

        for (let i = 0; i < 4; i++) {
          const cell = row.insertCell();
          const input = document.createElement("input");
          input.className = "form-control";
          input.type = "text";
          if (i === 0) input.value = rowNumber;
          if (i === 3) {
            input.classList.add("amount");
            input.type = "number";
            input.step = "0.01";
          }
          input.oninput = updateTotals;
          cell.appendChild(input);
        }

        const deleteCell = row.insertCell();
        deleteCell.innerHTML = `
          <button type="button" class="icon-button" onclick="removeRow(this)" title="Delete row">
    <i class="bi bi-trash"></i>
  </button>
`;
      }

      // Remove row function
      function removeRow(button) {
        const row = button.closest("tr");
        const tbody = document.getElementById("credit-note-body");
        if (tbody.children.length > 1) {
          row.remove();
          updateRowNumbers();
          updateTotals();
        }
      }

      // Update row numbers
      function updateRowNumbers() {
        const rows = document.querySelectorAll("#credit-note-body tr");
        rows.forEach((row, index) => {
          const numberInput = row.querySelector("input[type='text']");
          if (numberInput) {
            numberInput.value = index + 1;
          }
        });
      }

      // Form submission
      function submitForm() {
        const errors = [];

        const creditNoteNumberEl =
          document.getElementById("credit_note_number");
        const creditNoteDateEl = document.getElementById("credit_note_date");
        const projectNameEl = document.getElementById("project_name");

        const creditNoteNumber = creditNoteNumberEl.value.trim();
        const creditNoteDate = creditNoteDateEl.value.trim();
        const projectValue = projectNameEl.value.trim();

        // Clear previous validation errors
        [projectNameEl, creditNoteNumberEl, creditNoteDateEl].forEach((el) =>
          el.classList.remove("is-invalid")
        );

        // Validate required fields
        if (!validProjectNames.includes(projectValue)) {
          errors.push("Project Name must be selected from the list.");
          projectNameEl.classList.add("is-invalid");
        }
        if (!creditNoteNumber) {
          errors.push("Credit Note Number is required.");
          creditNoteNumberEl.classList.add("is-invalid");
        }
        if (!creditNoteDate) {
          errors.push("Credit Note Date is required.");
          creditNoteDateEl.classList.add("is-invalid");
        }

        if (errors.length > 0) {
          alert("Please fix the following errors:\n• " + errors.join("\n• "));
          return;
        }

        // Check if we need to load project details first (like in invoices)
        if (
          !window.currentProjectDetails ||
          !window.currentProjectDetails.clientName ||
          !window.currentProjectDetails.templateId
        ) {
          console.log("Project details not loaded, loading now...");
          document.getElementById("generate-btn").disabled = true;
          document.getElementById("spinner").style.display = "inline-block";
          // Don't disable form inputs here - let fillProjectDetails work

          google.script.run
            .withSuccessHandler(function (details) {
              window.currentProjectDetails = details;
              console.log("Project details loaded:", details);
              // Fill the form fields with loaded details
              fillProjectDetails(details);
              // Now submit the form with the loaded details
              submitFormWithData();
            })
            .withFailureHandler(function (error) {
              console.error("Failed to load project details:", error);
              alert("Failed to load project details. Please try again.");
              document.getElementById("generate-btn").disabled = false;
              document.getElementById("spinner").style.display = "none";
            })
            .getProjectDetails(projectValue);
          return;
        }

        // If project details are already loaded, submit directly
        submitFormWithData();
      }

      function submitFormWithData() {
        const projectValue = document
          .getElementById("project_name")
          .value.trim();

        // Debug logging
        console.log(
          "window.currentProjectDetails:",
          window.currentProjectDetails
        );
        console.log(
          "tax from currentProjectDetails:",
          window.currentProjectDetails?.tax
        );
        console.log(
          "tax from DOM:",
          document.getElementById("tax").textContent.trim()
        );

        const data = {
          projectName: projectValue,
          creditNoteNumber: document
            .getElementById("credit_note_number")
            .value.trim(),
          // Use data from currentProjectDetails if available, fallback to textContent
          clientName:
            window.currentProjectDetails?.clientName ||
            document.getElementById("client_name").textContent.trim(),
          clientAddress:
            window.currentProjectDetails?.clientAddress ||
            document.getElementById("client_address").textContent.trim(),
          clientNumber:
            window.currentProjectDetails?.clientNumber ||
            document.getElementById("client_number").textContent.trim(),
          ourCompany:
            window.currentProjectDetails?.ourCompany ||
            document.getElementById("our_company").textContent.trim(),
          creditNoteDate: document
            .getElementById("credit_note_date")
            .value.trim(),
          tax:
            window.currentProjectDetails?.tax ||
            document.getElementById("tax").textContent.trim(),
          subtotal: document.getElementById("subtotal").textContent.trim(),
          total: document.getElementById("total").textContent.trim(),
          exchangeRate: document.getElementById("exchange_rate").value.trim(),
          currency:
            window.currentProjectDetails?.currency ||
            document
              .getElementById("currency")
              .textContent.trim()
              .split(" ")[0],
          amountInEUR: document
            .getElementById("amount_in_eur")
            .textContent.trim(),
          bankDetails1: window.currentProjectDetails?.bankDetails1 || "",
          bankDetails2: window.currentProjectDetails?.bankDetails2 || "",
          comment: document.getElementById("comment").value.trim(),
          items: [],
        };

        // Calculate tax amount
        const subtotal = parseFloat(data.subtotal) || 0;
        const taxRate = parseFloat(data.tax) || 0;
        data.taxAmount = ((subtotal * taxRate) / 100).toFixed(2);

        // Collect items from table (only first 4 columns for credit notes)
        const tbody = document.getElementById("credit-note-body");
        for (let row of tbody.rows) {
          const inputs = row.getElementsByTagName("input");
          const rowData = Array.from(inputs)
            .slice(0, 4)
            .map((i) => i.value.trim());
          data.items.push(rowData);
        }

        console.log(
          "Data being sent to server:",
          JSON.stringify(data, null, 2)
        );

        // Enable spinner and disable button + form
        document.getElementById("generate-btn").disabled = true;
        document.getElementById("spinner").style.display = "inline-block";
        setFormInputsDisabled(true);
        document.getElementById("result").innerHTML = "";

        google.script.run
          .withFailureHandler(function (error) {
            document.getElementById("spinner").style.display = "none";
            document.getElementById("generate-btn").disabled = false;
            setFormInputsDisabled(false);
            alert(
              "An error occurred: " +
                error.message +
                "\n\nPlease check the browser console for more details."
            );
            console.error("Server-side call failed:", error);
          })
          .withSuccessHandler(function (result) {
            console.log("Credit Note generation result:", result);
            document.getElementById("spinner").style.display = "none";
            setFormInputsDisabled(true);

            let resultHtml = `
      <div class="alert alert-success mt-4">
                <strong>Credit Note created successfully!</strong>
      </div>
    `;

            // Add document links if available
            if (result && (result.docUrl || result.pdfUrl)) {
              resultHtml += `
                <div class="card mt-3" style="background-color: #d4edda; border-color: #c3e6cb;">
                  <div class="card-body">
                    <h6 class="card-title text-success mb-3">
                      <i class="bi bi-check-circle"></i> Documents Generated
                    </h6>
                    <div class="d-flex flex-wrap gap-2">
              `;

              if (result.docUrl) {
                resultHtml += `
                  <a href="${result.docUrl}" target="_blank" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-file-earmark-text"></i> Open Google Doc
                  </a>
                `;
              }

              if (result.pdfUrl) {
                resultHtml += `
                  <a href="${result.pdfUrl}" target="_blank" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-file-earmark-pdf"></i> Open PDF
                  </a>
                `;
              }

              resultHtml += `
                    </div>
                  </div>
      </div>
    `;
            }

            resultHtml += `
              <div class="row mt-4">
                <div class="col-md-12 d-flex justify-content-end gap-2">
                  <button class="btn btn-primary px-5 fw-bold" onclick="safeNavigateToCreditNotesList()">Back to the list</button>
                </div>
          </div>
        `;

            document.getElementById("result").innerHTML = resultHtml;

            // Hide generate button after success
            document.getElementById("generate-btn").style.display = "none";
            document.getElementById("cancel-create-btn").style.display = "none";
          })
          .processCreditNoteForm(data);
      }

      // Initialize tooltips and event listeners
      document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Add event listeners for amount inputs
        document.addEventListener("change", function (e) {
          if (e.target.classList.contains("amount-input")) {
            updateTotals();
          }
        });
      });
    </script>
  </body>
</html>
