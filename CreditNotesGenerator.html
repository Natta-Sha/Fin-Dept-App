<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Create Credit Note</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .form-label {
        font-weight: bold;
      }

      .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25) !important;
      }

      .btn-outline-danger:focus {
        box-shadow: none !important;
      }

      .icon-button {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: #6c757d;
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button i {
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button:hover i {
        color: #000 !important;
        transform: scale(1.2);
      }

      .icon-button:focus {
        outline: none;
        box-shadow: none;
      }

      .main-content {
        padding-top: 1rem;
      }

      /* Table column widths */
      #credit-note-table th:nth-child(1),
      #credit-note-table td:nth-child(1) {
        width: 10% !important;
        min-width: 100px;
      }
      #credit-note-table th:nth-child(2),
      #credit-note-table td:nth-child(2) {
        width: 50% !important;
      }
      #credit-note-table th:nth-child(3),
      #credit-note-table td:nth-child(3) {
        width: 20% !important;
      }
      #credit-note-table th:nth-child(4),
      #credit-note-table td:nth-child(4) {
        width: 20% !important;
      }
      #credit-note-table th:nth-child(5),
      #credit-note-table td:nth-child(5) {
        width: 5% !important;
        min-width: 50px;
      }

      /* Universal button styles */
      .btn {
        font-weight: 600 !important;
        border-radius: 25px !important;
        padding: 0.75rem 2rem !important;
        font-size: 1.1rem !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        border: none !important;
      }

      .btn:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
      }

      .btn:focus,
      .btn:active {
        transform: translateY(-1px) !important;
      }

      /* Small buttons */
      .btn-sm {
        padding: 0.25rem 0.75rem !important;
        font-size: 0.8rem !important;
        border-radius: 15px !important;
      }

      /* Add row button - compact */
      #add-row-btn {
        padding: 0.4rem 1rem !important;
        font-size: 0.9rem !important;
        border-radius: 20px !important;
      }

      /* Primary buttons (главные действия) */
      .btn-primary,
      .btn-nav {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:hover,
      .btn-nav:hover {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:focus,
      .btn-primary:active,
      .btn-nav:focus,
      .btn-nav:active {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
      }

      /* Success buttons (создание/копирование) */
      .btn-success {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
      }

      .btn-success:hover {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
      }

      .btn-success:focus,
      .btn-success:active {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25) !important;
      }

      /* Danger buttons (удаление) */
      .btn-danger {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:hover {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:focus,
      .btn-danger:active {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
      }

      /* Outline buttons (secondary actions) */
      .btn-outline-primary {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        ) !important;
        color: #667eea !important;
        border: 2px solid #667eea !important;
      }

      .btn-outline-primary:hover {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
        border-color: #667eea !important;
      }

      .btn-outline-secondary {
        background: linear-gradient(
          135deg,
          rgba(108, 117, 125, 0.1) 0%,
          rgba(73, 80, 87, 0.1) 100%
        ) !important;
        color: #6c757d !important;
        border: 2px solid #6c757d !important;
      }

      .btn-outline-secondary:hover {
        background: linear-gradient(
          135deg,
          #6c757d 0%,
          #495057 100%
        ) !important;
        color: white !important;
        border-color: #6c757d !important;
      }

      .btn-outline-danger {
        background: linear-gradient(
          135deg,
          rgba(220, 53, 69, 0.1) 0%,
          rgba(176, 42, 55, 0.1) 100%
        ) !important;
        color: #dc3545 !important;
        border: 2px solid #dc3545 !important;
      }

      .btn-outline-danger:hover {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
        border-color: #dc3545 !important;
      }

      .btn-outline-success {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(32, 105, 43, 0.1) 100%
        ) !important;
        color: #28a745 !important;
        border: 2px solid #28a745 !important;
      }

      .btn-outline-success:hover {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
        border-color: #28a745 !important;
      }
    </style>
    <!-- Bootstrap JS (для модальных окон) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <!-- Top Navigation -->
    <?!= getNavigation(activePage) ?>

    <!-- Main Content -->
    <div class="main-content container">
      <h2 id="page-title" class="mb-4">Create Credit Note</h2>

      <!-- Credit Note Form -->
      <form id="credit-note-form">
        <!-- Basic Information -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label"
              >Project Name <span class="text-danger">*</span></label
            >
            <input
              list="project_list"
              id="project_name"
              class="form-control"
              placeholder="Start typing to search..."
              required
            />
            <datalist id="project_list"></datalist>
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >Credit Note Number <span class="text-danger">*</span></label
            >
            <input
              id="credit_note_number"
              type="text"
              class="form-control"
              required
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Client Name</label>
            <p class="form-control-plaintext" id="client_name"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Client Address</label>
            <p class="form-control-plaintext" id="client_address"></p>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Client Number</label>
            <p class="form-control-plaintext" id="client_number"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Our Company</label>
            <p class="form-control-plaintext" id="our_company"></p>
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >Credit Note Date <span class="text-danger">*</span></label
            >
            <input
              id="credit_note_date"
              type="date"
              class="form-control"
              required
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Exchange Rate</label>
            <p class="form-control-plaintext" id="exchange_rate_display"></p>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Currency</label>
            <p class="form-control-plaintext" id="currency">$ (USD)</p>
          </div>
        </div>

        <!-- Comment -->
        <div class="mb-3">
          <label class="form-label">Comment</label>
          <input
            type="text"
            id="comment"
            class="form-control"
            placeholder="Optional comment for credit note"
          />
        </div>

        <!-- Items table -->
        <table class="table table-bordered" id="credit-note-table">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Description</th>
              <th>Period</th>
              <th>Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="credit-note-body">
            <tr>
              <td>
                <input type="text" class="form-control" value="1" readonly />
              </td>
              <td><input type="text" class="form-control" /></td>
              <td><input type="text" class="form-control" /></td>
              <td>
                <input
                  type="number"
                  class="form-control amount-input"
                  step="0.01"
                />
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>

        <button
          class="btn btn-outline-primary mb-3"
          onclick="addRow()"
          id="add-row-btn"
        >
          + Add Row
        </button>

        <!-- Totals -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Tax (%)</label>
            <p class="form-control-plaintext" id="tax">19</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Subtotal</label>
            <p class="form-control-plaintext" id="subtotal">0.00</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Total</label>
            <p class="form-control-plaintext" id="total">0.00</p>
          </div>
          <div class="col-md-3">
            <label class="form-label">Amount in EUR</label>
            <p class="form-control-plaintext" id="amount_in_eur"></p>
          </div>
        </div>
      </form>

      <div class="row mt-4 mb-4">
        <div
          class="col-md-12 d-flex justify-content-end gap-2"
          id="action-buttons"
        >
          <button
            id="generate-btn"
            class="btn btn-success"
            onclick="submitForm()"
          >
            Generate Credit Note
          </button>
          <button
            id="cancel-create-btn"
            class="btn btn-outline-secondary ms-2"
            onclick="safeNavigateToCreditNotesList()"
          >
            Cancel
          </button>
          <div
            id="spinner"
            class="spinner-border text-primary ms-3"
            style="display: none"
            role="status"
          >
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      let rowCount = 1;

      // Navigation function
      function safeNavigateToCreditNotesList() {
        window.location.href = "<?= baseUrl ?>?page=CreditNotesList";
      }

      // Add row function
      function addRow() {
        rowCount++;
        const tbody = document.getElementById("credit-note-body");
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
          <td><input type="text" class="form-control" value="${rowCount}" readonly /></td>
          <td><input type="text" class="form-control" /></td>
          <td><input type="text" class="form-control" /></td>
          <td><input type="number" class="form-control amount-input" step="0.01" onchange="calculateTotals()" /></td>
          <td>
            <button type="button" class="icon-button" onclick="removeRow(this)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(newRow);
        updateRowNumbers();
      }

      // Remove row function
      function removeRow(button) {
        const row = button.closest("tr");
        const tbody = document.getElementById("credit-note-body");
        if (tbody.children.length > 1) {
          row.remove();
          updateRowNumbers();
          calculateTotals();
        }
      }

      // Update row numbers
      function updateRowNumbers() {
        const rows = document.querySelectorAll("#credit-note-body tr");
        rows.forEach((row, index) => {
          const numberInput = row.querySelector("input[type='text']");
          if (numberInput) {
            numberInput.value = index + 1;
          }
        });
      }

      // Calculate totals
      function calculateTotals() {
        const amountInputs = document.querySelectorAll(".amount-input");
        let subtotal = 0;

        amountInputs.forEach((input) => {
          const value = parseFloat(input.value) || 0;
          subtotal += value;
        });

        const taxRate = 19; // Default tax rate
        const tax = (subtotal * taxRate) / 100;
        const total = subtotal + tax;

        document.getElementById("subtotal").textContent = subtotal.toFixed(2);
        document.getElementById("total").textContent = total.toFixed(2);
        // Amount in EUR will be calculated when needed (like in invoices)
        document.getElementById("amount_in_eur").textContent = "";
      }

      // Form submission (placeholder)
      function submitForm() {
        // Basic validation
        const projectName = document
          .getElementById("project_name")
          .value.trim();
        const creditNoteNumber = document
          .getElementById("credit_note_number")
          .value.trim();
        const creditNoteDate =
          document.getElementById("credit_note_date").value;

        if (!projectName || !creditNoteNumber || !creditNoteDate) {
          alert("Please fill in all required fields (marked with *)");
          return;
        }

        alert("Generate Credit Note functionality coming soon!");
      }

      // Initialize tooltips and event listeners
      document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Add event listeners for amount inputs
        document.addEventListener("change", function (e) {
          if (e.target.classList.contains("amount-input")) {
            calculateTotals();
          }
        });
      });
    </script>
  </body>
</html>
