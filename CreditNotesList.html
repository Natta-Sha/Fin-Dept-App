<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <title>List of Credit Notes</title>

    <!-- Стили -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css"
    />

    <!-- Скрипты -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.13.4/sorting/datetime-moment.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

    <style>
      body {
        font-size: 0.875rem; /* уменьшенный шрифт */
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .main-content {
        flex-grow: 1;
        padding: 20px;
      }

      /* Universal button styles */
      .btn {
        font-weight: 600 !important;
        border-radius: 25px !important;
        padding: 0.75rem 2rem !important;
        font-size: 1.1rem !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
        border: none !important;
      }

      .btn:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
      }

      .btn:focus,
      .btn:active {
        transform: translateY(-1px) !important;
      }

      /* Small buttons */
      .btn-sm {
        padding: 0.25rem 0.75rem !important;
        font-size: 0.8rem !important;
        border-radius: 15px !important;
      }

      /* Primary buttons (главные действия) */
      .btn-primary,
      .btn-nav {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:hover,
      .btn-nav:hover {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
      }

      .btn-primary:focus,
      .btn-primary:active,
      .btn-nav:focus,
      .btn-nav:active {
        background: linear-gradient(
          135deg,
          #5a6fd8 0%,
          #6b4190 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
      }

      /* Success buttons (создание/копирование) */
      .btn-success {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
      }

      .btn-success:hover {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
      }

      .btn-success:focus,
      .btn-success:active {
        background: linear-gradient(
          135deg,
          #218838 0%,
          #1e5e26 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25) !important;
      }

      /* Danger buttons (удаление) */
      .btn-danger {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:hover {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
      }

      .btn-danger:focus,
      .btn-danger:active {
        background: linear-gradient(
          135deg,
          #c82333 0%,
          #9e2530 100%
        ) !important;
        color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
      }

      /* Outline buttons (secondary actions) */
      .btn-outline-primary {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        ) !important;
        color: #667eea !important;
        border: 2px solid #667eea !important;
      }

      .btn-outline-primary:hover {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        color: white !important;
        border-color: #667eea !important;
      }

      .btn-outline-secondary {
        background: linear-gradient(
          135deg,
          rgba(108, 117, 125, 0.1) 0%,
          rgba(73, 80, 87, 0.1) 100%
        ) !important;
        color: #6c757d !important;
        border: 2px solid #6c757d !important;
      }

      .btn-outline-secondary:hover {
        background: linear-gradient(
          135deg,
          #6c757d 0%,
          #495057 100%
        ) !important;
        color: white !important;
        border-color: #6c757d !important;
      }

      .btn-outline-danger {
        background: linear-gradient(
          135deg,
          rgba(220, 53, 69, 0.1) 0%,
          rgba(176, 42, 55, 0.1) 100%
        ) !important;
        color: #dc3545 !important;
        border: 2px solid #dc3545 !important;
      }

      .btn-outline-danger:hover {
        background: linear-gradient(
          135deg,
          #dc3545 0%,
          #b02a37 100%
        ) !important;
        color: white !important;
        border-color: #dc3545 !important;
      }

      .btn-outline-success {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.1) 0%,
          rgba(32, 105, 43, 0.1) 100%
        ) !important;
        color: #28a745 !important;
        border: 2px solid #28a745 !important;
      }

      .btn-outline-success:hover {
        background: linear-gradient(
          135deg,
          #28a745 0%,
          #20692b 100%
        ) !important;
        color: white !important;
        border-color: #28a745 !important;
      }

      th,
      td {
        padding: 4px 8px !important; /* компактнее строки */
      }

      table.dataTable {
        width: 100% !important;
      }

      th:nth-child(1),
      td:nth-child(1) {
        width: 20%;
      }
      th:nth-child(2),
      td:nth-child(2) {
        width: 15%;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 15%;
      }
      th:nth-child(4),
      td:nth-child(4) {
        width: 15%;
      }
      th:nth-child(5),
      td:nth-child(5) {
        width: 10%;
      }
      th:nth-child(6),
      td:nth-child(6) {
        width: 25%;
        white-space: nowrap;
      }

      thead input {
        width: 100%;
        box-sizing: border-box;
        padding: 4px;
      }

      /* Выравнивание заголовков по центру */
      #creditNoteTable thead th {
        text-align: center !important;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <!-- Top Navigation -->
    <?!= getNavigation(activePage) ?>

    <!-- Main Content -->
    <div class="main-content container">
      <div class="mb-3 d-flex justify-content-start">
        <a
          href="<?= baseUrl ?>?page=CreditNotesGenerator&mode=create"
          class="btn btn-nav"
        >
          Generate Credit Note
        </a>
      </div>

      <script>
        function goHome() {
          window.location.href = "?page=Home";
        }
      </script>

      <h2 class="mb-4">List of Credit Notes</h2>

      <table
        id="creditNoteTable"
        class="display table table-bordered"
        style="width: 100%; display: none"
      >
        <thead class="table-light">
          <tr>
            <th>Project Name</th>
            <th>Credit Note Number</th>
            <th>Credit Note Date</th>
            <th>Total</th>
            <th>Currency</th>
            <th>Actions</th>
          </tr>
          <tr>
            <th><input type="text" placeholder="Search Project" /></th>
            <th><input type="text" placeholder="Search Number" /></th>
            <th><input type="text" placeholder="Search Date" /></th>
            <th><input type="text" placeholder="Search Total" /></th>
            <th><input type="text" placeholder="Search Currency" /></th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <script>
        function goHome() {
          window.location.href = "?page=Home";
        }
      </script>
      <script>
        $(document).ready(function () {
          $.fn.dataTable.moment("DD/MM/YYYY");
          const table = $("#creditNoteTable").DataTable({
            dom: "lrtip",
            orderCellsTop: true,
            columnDefs: [
              {
                targets: 3, // колонка Total (индекс 3)
                className: "dt-body-right dt-head-center", // данные вправо, заголовок по центру
                render: function (data, type, row) {
                  if (type === "display" && data) {
                    // Форматируем число с запятыми для отображения
                    const num = parseFloat(data);
                    if (!isNaN(num)) {
                      return num.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      });
                    }
                  }
                  return data;
                },
              },
              {
                targets: [0, 1, 2, 4, 5], // все колонки кроме Total (3)
                className: "dt-body-left dt-head-center", // данные влево, заголовок по центру
              },
            ],
          });

          new $.fn.dataTable.FixedHeader(table);

          $("#creditNoteTable thead tr:eq(1) th").each(function (i) {
            $("input", this).on("keyup change", function () {
              if (table.column(i).search() !== this.value) {
                table.column(i).search(this.value).draw();
              }
            });
          });

          google.script.run
            .withSuccessHandler(function (data) {
              console.log(
                "Credit Notes List: Received data from server:",
                data
              );
              console.log("Credit Notes List: Data type:", typeof data);
              console.log("Credit Notes List: Is array:", Array.isArray(data));
              console.log(
                "Credit Notes List: Data length:",
                data ? data.length : "undefined"
              );

              if (!Array.isArray(data) || data.length === 0) {
                console.log(
                  "Credit Notes List: No data or empty array, clearing table"
                );
                table.clear().draw();
                document.getElementById("creditNoteTable").style.display = "";
                return;
              }

              console.log(
                "Credit Notes List: Processing " + data.length + " rows"
              );
              data.forEach((row, index) => {
                if (index < 3) {
                  // Log first 3 rows
                  console.log(
                    "Credit Notes List: Row " + (index + 1) + ":",
                    row
                  );
                }
                table.row.add([
                  row.projectName || "",
                  row.creditNoteNumber || "",
                  row.creditNoteDate || "",
                  row.total || "",
                  row.currency || "",
                  `
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="showComingSoon('View Credit Note')">View</button>
                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="showComingSoon('Edit Credit Note')">Edit</button>
                  <button class="btn btn-sm btn-outline-danger me-1" onclick="showComingSoon('Delete Credit Note')">Delete</button>
                  <button class="btn btn-sm btn-outline-success" onclick="showComingSoon('Copy Credit Note')">Copy</button>
                `,
                ]);
              });

              table.draw();
              document.getElementById("creditNoteTable").style.display = "";
            })
            .withFailureHandler(function (error) {
              console.error(
                "Credit Notes List: Error loading credit note list:",
                error
              );
              console.error(
                "Credit Notes List: Error details:",
                JSON.stringify(error)
              );
              alert(
                "Failed to load credit note list. Check console for details."
              );
            })
            .getCreditNoteListFromData();
        });
      </script>

      <!-- Modal for deletion info -->
      <div
        class="modal fade"
        id="deletedModal"
        tabindex="-1"
        aria-labelledby="deletedModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deletedModalLabel">
                Credit Note Deleted
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">The credit note was deleted.</div>
          </div>
        </div>
      </div>
      <script>
        // Show modal if deleted=1 in URL
        $(function () {
          const params = new URLSearchParams(window.location.search);
          if (params.get("deleted") === "1") {
            const modal = new bootstrap.Modal(
              document.getElementById("deletedModal")
            );
            modal.show();
          }
        });
      </script>
    </div>
    <!-- Close main-content -->

    <script>
      // Initialize Bootstrap tooltips
      document.addEventListener("DOMContentLoaded", function () {
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      });

      // Temporary function for items not yet converted to tooltips
      function showComingSoon(feature) {
        // Show a more pleasant "coming soon" message
        var tooltip = document.createElement("div");
        tooltip.className =
          "alert alert-info alert-dismissible fade show position-fixed";
        tooltip.style.top = "20px";
        tooltip.style.right = "20px";
        tooltip.style.zIndex = "9999";
        tooltip.innerHTML = `
          <strong>${feature}</strong> feature is coming soon!
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(tooltip);
        setTimeout(() => {
          if (tooltip.parentNode) tooltip.parentNode.removeChild(tooltip);
        }, 3000);
      }
    </script>
  </body>
</html>
