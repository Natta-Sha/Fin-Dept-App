<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="utf-8" />
    <title>Create Invoice</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .form-label {
        font-weight: bold;
      }

      .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25) !important;
      }

      .btn-outline-danger:focus {
        box-shadow: none !important;
      }

      .icon-button {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: #6c757d;
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button i {
        transition: transform 0.15s ease, color 0.15s ease;
      }

      .icon-button:hover i {
        color: #000 !important;
        transform: scale(1.2);
      }

      .icon-button:focus {
        outline: none;
        box-shadow: none;
      }
    </style>
    <!-- Bootstrap JS (–¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body class="container py-4">
    <div class="mb-4 d-flex justify-content-between">
      <a href="<?= baseUrl ?>?page=Home" class="btn btn-link"
        >&larr; Back to Main Page</a
      >
      <a
        href="<?= baseUrl ?>?page=InvoicesList"
        class="btn btn-link"
        id="back-to-list"
        >&larr; Back to Invoices List</a
      >
    </div>
    <div
      class="modal fade"
      id="deleteSuccessModal"
      tabindex="-1"
      aria-labelledby="deleteSuccessLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteSuccessLabel">Success</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">The invoice was successfully deleted.</div>
        </div>
      </div>
    </div>

    <!-- Save success modal -->
    <div
      class="modal fade"
      id="saveSuccessModal"
      tabindex="-1"
      aria-labelledby="saveSuccessLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="saveSuccessLabel">Saved</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Invoice changes have been saved.</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              OK
            </button>
          </div>
        </div>
      </div>
    </div>
    <script>
      function goHome() {
        window.location.href = "?page=Home";
      }
    </script>

    <h2 class="mb-4" id="page-title">Create invoice</h2>

    <!-- Invoice details -->
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label"
          >Project Name <span class="text-danger">*</span></label
        >
        <input
          list="project_list"
          id="project_name"
          class="form-control"
          placeholder="Start typing to search..."
          required
        />
        <datalist id="project_list"></datalist>
      </div>
      <div class="col-md-3">
        <label class="form-label"
          >Invoice Number <span class="text-danger">*</span></label
        >
        <input id="invoice_number" type="text" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">Client Name</label>
        <p class="form-control-plaintext" id="client_name"></p>
        <input
          id="client_name_input"
          type="text"
          class="form-control"
          style="display: none"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">Client Address</label>
        <p class="form-control-plaintext" id="client_address"></p>
        <textarea
          id="client_address_input"
          class="form-control"
          rows="2"
          style="display: none"
        ></textarea>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Client Number</label>
        <p class="form-control-plaintext" id="client_number"></p>
        <input
          id="client_number_input"
          type="text"
          class="form-control"
          style="display: none"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">Our Company</label>
        <p class="form-control-plaintext" id="our_company"></p>
        <input
          id="our_company_input"
          type="text"
          class="form-control"
          style="display: none"
        />
      </div>

      <div class="col-md-3">
        <label class="form-label"
          >Invoice Date <span class="text-danger">*</span></label
        >
        <input id="invoice_date" type="date" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Due Date</label>
        <p class="form-control-plaintext" id="due_date"></p>
        <input
          id="due_date_input"
          type="date"
          class="form-control"
          style="display: none"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label" for="exchange_rate" id="exchange_rate_label"
          >Exchange Rate</label
        >
        <p class="form-control-plaintext" id="exchange_rate_display"></p>
        <input
          id="exchange_rate"
          type="number"
          step="0.0001"
          class="form-control"
          value="1.0000"
          oninput="updateTotals()"
          style="display: none"
        />
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Currency</label>
        <p class="form-control-plaintext" id="currency">$ (USD)</p>
      </div>
      <div class="col-md-9">
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Bank Details 1</label>
            <pre class="form-control-plaintext" id="bank_details_1"></pre>
            <textarea
              id="bank_details_1_input"
              class="form-control"
              rows="4"
              style="display: none"
            ></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Bank Details 2</label>
            <pre class="form-control-plaintext" id="bank_details_2"></pre>
            <textarea
              id="bank_details_2_input"
              class="form-control"
              rows="4"
              style="display: none"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Comment -->
    <div class="mb-3">
      <label class="form-label">Comment</label>
      <p
        class="form-control-plaintext"
        id="comment-display"
        style="display: none"
      ></p>
      <input
        type="text"
        id="comment"
        class="form-control"
        placeholder="Optional comment for invoice"
      />
    </div>

    <!-- Items table -->
    <table class="table table-bordered" id="invoice-table">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Service</th>
          <th>Period</th>
          <th>Quantity</th>
          <th>Rate/hour</th>
          <th>Amount</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="invoice-body">
        <tr>
          <td><input type="text" class="form-control" value="1" /></td>
          <td><input type="text" class="form-control" /></td>
          <td><input type="text" class="form-control" /></td>
          <td>
            <input type="text" class="form-control" oninput="updateTotals()" />
          </td>
          <td>
            <input type="text" class="form-control" oninput="updateTotals()" />
          </td>
          <td>
            <input
              type="text"
              class="form-control amount"
              onfocus="markManualAmount(event)"
            />
          </td>
        </tr>
      </tbody>
    </table>

    <button
      class="btn btn-outline-primary mb-3"
      onclick="addRow()"
      id="add-row-btn"
    >
      + Add Row
    </button>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Tax (%)</label>
        <p class="form-control-plaintext" id="tax">19</p>
      </div>
      <div class="col-md-3">
        <label class="form-label">Subtotal</label>
        <p class="form-control-plaintext" id="subtotal">0.00</p>
      </div>
      <div class="col-md-3">
        <label class="form-label">Total</label>
        <p class="form-control-plaintext" id="total">0.00</p>
      </div>
      <div class="col-md-3">
        <label class="form-label">Amount in EUR</label>
        <p class="form-control-plaintext" id="amount_in_eur"></p>
      </div>
    </div>

    <div class="row mt-4">
      <div
        class="col-md-12 d-flex justify-content-end gap-2"
        id="action-buttons"
      >
        <button
          id="generate-btn"
          class="btn btn-success"
          onclick="submitForm()"
        >
          Generate Invoice
        </button>
        <div
          id="spinner"
          class="spinner-border text-primary ms-3"
          style="display: none"
          role="status"
        >
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>

    <div id="result" class="mt-4"></div>

    <div id="delete-section" style="display: none">
      <button id="delete-btn" class="btn btn-danger">Delete</button>
      <div
        id="delete-spinner"
        class="spinner-border text-danger ms-3"
        style="display: none"
        role="status"
      >
        <span class="visually-hidden">Deleting...</span>
      </div>
    </div>

    <div id="delete-bottom-btn-container" style="display: none">
      <div class="row mt-4">
        <div
          class="col-md-12 d-flex justify-content-end gap-2 align-items-center"
        >
          <button id="delete-bottom-btn" class="btn btn-danger px-5 fw-bold">
            Delete
          </button>
          <div
            id="delete-bottom-spinner"
            class="spinner-border text-danger ms-2"
            style="display: none"
            role="status"
          >
            <span class="visually-hidden">Deleting...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Copy mode bottom actions -->
    <div id="copy-bottom-btn-container" style="display: none">
      <div class="row mt-4">
        <div class="col-md-12 d-flex justify-content-end gap-2">
          <button id="copy-create-new-btn" class="btn btn-success px-5 fw-bold">
            Create new
          </button>
          <button
            id="copy-cancel-btn"
            class="btn btn-outline-secondary px-5 fw-bold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Edit mode bottom actions -->
    <div id="edit-bottom-btn-container" style="display: none">
      <div class="row mt-4">
        <div
          class="col-md-12 d-flex justify-content-end gap-2 align-items-center"
        >
          <button
            id="save-with-changes-btn"
            class="btn btn-primary px-5 fw-bold"
          >
            Save changes
          </button>
          <button
            id="save-without-changes-btn"
            class="btn btn-outline-secondary px-5 fw-bold"
          >
            Discard changes
          </button>
          <div
            id="edit-spinner"
            class="spinner-border text-primary ms-2"
            style="display: none"
            role="status"
          >
            <span class="visually-hidden">Saving...</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Robust navigation back to invoices list for both web-app and sidebar contexts
      function safeNavigateToInvoicesList() {
        const target = BASE_URL + "?page=InvoicesList";
        try {
          window.top.location.href = target;
          return;
        } catch (e) {}
        try {
          window.location.href = target;
          return;
        } catch (e2) {}
        if (
          google &&
          google.script &&
          google.script.host &&
          google.script.host.close
        ) {
          google.script.host.close();
        }
      }

      // Disable/enable all form fields (inputs, textareas, row controls)
      function setFormInputsDisabled(isDisabled) {
        try {
          document.querySelectorAll("input, textarea").forEach((el) => {
            el.disabled = isDisabled;
          });
          const addRowBtnEl = document.getElementById("add-row-btn");
          if (addRowBtnEl) addRowBtnEl.disabled = isDisabled;
        } catch (_) {}
      }
      // Build payload for Save changes from current UI values
      function buildCurrentFormDataForSave() {
        const projectValue = document
          .getElementById("project_name")
          .value.trim();
        const toDDMMYYYY = (yyyyMmDd) => {
          if (!yyyyMmDd) return "";
          const [y, m, d] = yyyyMmDd.split("-");
          return `${d}/${m}/${y}`;
        };

        const payload = {
          projectName: projectValue,
          invoiceNumber: document.getElementById("invoice_number").value.trim(),
          clientName: document.getElementById("client_name_input").value.trim(),
          clientAddress: document
            .getElementById("client_address_input")
            .value.trim(),
          clientNumber: document
            .getElementById("client_number_input")
            .value.trim(),
          invoiceDate: document.getElementById("invoice_date").value.trim(),
          dueDate: toDDMMYYYY(
            (document.getElementById("due_date_input").value || "").trim()
          ),
          tax: document.getElementById("tax").textContent.trim(),
          subtotal: document.getElementById("subtotal").innerText.trim(),
          total: document.getElementById("total").innerText.trim(),
          exchangeRate: document.getElementById("exchange_rate").value.trim(),
          currency: document
            .getElementById("currency")
            .textContent.trim()
            .split(" ")[0],
          amountInEUR: document
            .getElementById("amount_in_eur")
            .innerText.trim(),
          bankDetails1: document
            .getElementById("bank_details_1_input")
            .value.trim(),
          bankDetails2: document
            .getElementById("bank_details_2_input")
            .value.trim(),
          ourCompany: document.getElementById("our_company_input").value.trim(),
          comment: document.getElementById("comment").value.trim(),
          items: [],
          templateId: window.currentProjectDetails?.templateId || "",
          folderId: window.currentProjectDetails?.folderId || "",
        };

        const tbody = document.getElementById("invoice-body");
        for (let row of tbody.rows) {
          const inputs = row.getElementsByTagName("input");
          const rowData = Array.from(inputs).map((i) => i.value.trim());
          payload.items.push(rowData);
        }

        return payload;
      }
      let validProjectNames = [];
      let invoiceId = "<?= invoiceId ?>";
      let mode = "<?= mode ?>";
      const BASE_URL = "<?= baseUrl ?>";

      function populateProjectNames() {
        console.log("[populateProjectNames] running...");
        // –£–∂–µ –≤–Ω—É—Ç—Ä–∏ populateProjectNames:
        google.script.run
          .withSuccessHandler(function (projects) {
            validProjectNames = projects;
            const datalist = document.getElementById("project_list");
            datalist.innerHTML = "";
            projects.forEach((name) => {
              const opt = document.createElement("option");
              opt.value = name;
              datalist.appendChild(opt);
            });

            if (mode === "create") {
              const selectedProject = document
                .getElementById("project_name")
                .value.trim();
              if (selectedProject) {
                google.script.run
                  .withSuccessHandler(fillProjectDetails)
                  .getProjectDetails(selectedProject);
              }
            }
          })
          .getProjectNames();
      }

      function fillProjectDetails(details) {
        window.currentProjectDetails = details;

        document.getElementById("client_name").textContent = details.clientName;
        document.getElementById("client_address").textContent =
          details.clientAddress;
        document.getElementById("client_number").textContent =
          details.clientNumber;
        document.getElementById("our_company").textContent =
          details.ourCompany || "";
        document.getElementById("tax").textContent = details.tax;

        const currencyMap = { $: "$ (USD)", "‚Ç¨": "‚Ç¨ (EUR)", "‚Ç¥": "‚Ç¥ (UAH)" };
        const currencySymbol = details.currency;
        document.getElementById("currency").textContent =
          currencyMap[currencySymbol] || currencySymbol;

        document.getElementById("bank_details_1").textContent =
          details.bankDetails1 || "";
        document.getElementById("bank_details_2").textContent =
          details.bankDetails2 || "";

        const invoiceDate = document.getElementById("invoice_date").value;
        if (invoiceDate) {
          let baseDate = new Date(invoiceDate);
          let dueDate;
          if (details.dayType === "WD") {
            dueDate = addWorkingDays(baseDate, details.paymentDelay);
          } else {
            dueDate = new Date(baseDate);
            dueDate.setDate(dueDate.getDate() + details.paymentDelay);
          }
          document.getElementById("due_date").textContent =
            formatDateDDMMYYYY(dueDate);
        }

        const exchangeInput = document.getElementById("exchange_rate");
        const exchangeDisplay = document.getElementById(
          "exchange_rate_display"
        );

        if (currencySymbol !== "$") {
          exchangeInput.style.display = "none";
          exchangeDisplay.textContent = "";
          document.getElementById("amount_in_eur").textContent = "";
        } else {
          exchangeInput.style.display = "block";
          exchangeInput.value = "1.0000";
          exchangeDisplay.innerHTML = `
    Exchange Rate (EUR 1 = USD ...)
    <a href="https://www.bundesbank.de/dynamic/action/en/statistics/time-series-databases/time-series-databases/745582/745582?dateSelect=2025&tsTab=0&listId=www_sdks_b01012_3&tsId=BBEX3.D.USD.EUR.BB.AC.000&id=0" target="_blank" class="ms-1 btn btn-link btn-sm p-0">Link</a>
  `;
        }

        updateTotals();
      }

      function renderSavedDataRaw(data) {
        document.getElementById("project_name").value = data.projectName;
        document.getElementById("invoice_number").value = data.invoiceNumber;
        document.getElementById("client_name").textContent = data.clientName;
        document.getElementById("client_address").textContent =
          data.clientAddress;
        document.getElementById("client_number").textContent =
          data.clientNumber;
        document.getElementById("our_company").textContent =
          data.ourCompany || "";
        document.getElementById("tax").textContent = data.tax || "0";

        const currencyMap = { $: "$ (USD)", "‚Ç¨": "‚Ç¨ (EUR)", "‚Ç¥": "‚Ç¥ (UAH)" };
        document.getElementById("currency").textContent =
          currencyMap[data.currency] || data.currency;

        document.getElementById("bank_details_1").textContent =
          data.bankDetails1 || "";
        document.getElementById("bank_details_2").textContent =
          data.bankDetails2 || "";

        document.getElementById("invoice_date").value = formatInputDate(
          data.invoiceDate
        );
        document.getElementById("due_date").textContent = data.dueDate || "";

        if (data.currency === "$") {
          document.getElementById("exchange_rate").style.display = "block";
          document.getElementById("exchange_rate").value =
            data.exchangeRate || "1.0000";
          document.getElementById("amount_in_eur").textContent =
            data.amountInEUR || "";
        }

        document.getElementById("comment").value = data.comment || "";

        const tbody = document.getElementById("invoice-body");
        tbody.innerHTML = "";

        data.items.forEach((item) => {
          const row = document.createElement("tr");
          item.forEach((value, j) => {
            const cell = document.createElement("td");
            const input = document.createElement("input");
            input.type = "text";
            input.className = "form-control";
            input.value = value;
            if (j === 5) input.classList.add("amount");
            input.disabled = true; // –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            cell.appendChild(input);
            row.appendChild(cell);
          });
          row.appendChild(document.createElement("td")); // –ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ –ø–æ–¥ –∫–Ω–æ–ø–∫–∏
          tbody.appendChild(row);
        });

        document.getElementById("subtotal").innerText = data.subtotal || "0.00";
        document.getElementById("total").innerText = data.total || "0.00";
      }

      function fillInvoiceFormFromSavedData(data) {
        document.getElementById("project_name").value = data.projectName;
        document.getElementById("invoice_number").value = data.invoiceNumber;
        document.getElementById("client_name").textContent = data.clientName;
        document.getElementById("client_address").textContent =
          data.clientAddress;
        document.getElementById("client_number").textContent =
          data.clientNumber;
        document.getElementById("our_company").textContent =
          data.ourCompany || "";
        document.getElementById("tax").textContent = data.tax || "0";

        const currencyMap = { $: "$ (USD)", "‚Ç¨": "‚Ç¨ (EUR)", "‚Ç¥": "‚Ç¥ (UAH)" };
        document.getElementById("currency").textContent =
          currencyMap[data.currency] || data.currency;

        document.getElementById("bank_details_1").textContent =
          data.bankDetails1 || "";
        document.getElementById("bank_details_2").textContent =
          data.bankDetails2 || "";
        document.getElementById("invoice_date").value = formatInputDate(
          data.invoiceDate
        );
        document.getElementById("due_date").textContent = data.dueDate || "";

        if (data.currency === "$") {
          document.getElementById("exchange_rate").style.display = "block";
          document.getElementById("exchange_rate").value =
            data.exchangeRate || "1.0000";
          document.getElementById("amount_in_eur").textContent =
            data.amountInEUR || "";
        }

        document.getElementById("comment").value = data.comment || "";

        // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
        const tbody = document.getElementById("invoice-body");
        tbody.innerHTML = ""; // –û—á–∏—Å—Ç–∏—Ç—å
        data.items.forEach((item, i) => {
          const row = document.createElement("tr");
          item.forEach((value, j) => {
            const cell = document.createElement("td");
            const input = document.createElement("input");
            input.type = "text";
            input.className = "form-control";
            input.value = value;
            if (j === 5) input.classList.add("amount");
            input.oninput = updateTotals;
            input.onfocus = markManualAmount;
            cell.appendChild(input);
            row.appendChild(cell);
          });
          const delCell = document.createElement("td");
          delCell.innerHTML = invoiceId
            ? "" // —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è, –µ—Å–ª–∏ invoiceId —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)
            : `
    <button type="button" class="icon-button" onclick="deleteRow(this)" title="Delete row">
      <i class="bi bi-trash"></i>
    </button>
  `;

          row.appendChild(delCell);
          tbody.appendChild(row);
        });

        updateTotals();
      }

      // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è input type="date"
      function formatInputDate(dateVal) {
        if (typeof dateVal === "string" && dateVal.includes("/")) {
          const [dd, mm, yyyy] = dateVal.split("/");
          return `${yyyy}-${mm.padStart(2, "0")}-${dd.padStart(2, "0")}`;
        }
        return dateVal;
      }

      if (["create", "edit"].includes(mode)) {
        document
          .getElementById("project_name")
          .addEventListener("change", function () {
            const value = this.value.trim();
            if (validProjectNames.includes(value) && mode === "create") {
              google.script.run
                .withSuccessHandler(fillProjectDetails)
                .getProjectDetails(value);
            }
          });

        document
          .getElementById("invoice_date")
          .addEventListener("change", function () {
            const value = this.value.trim();
            const project = document
              .getElementById("project_name")
              .value.trim();
            if (value && project && mode === "create") {
              google.script.run
                .withSuccessHandler(fillProjectDetails)
                .getProjectDetails(project);
            }
          });
      }

      function formatDateDDMMYYYY(dateObj) {
        const dd = String(dateObj.getDate()).padStart(2, "0");
        const mm = String(dateObj.getMonth() + 1).padStart(2, "0");
        const yyyy = dateObj.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      function addWorkingDays(startDate, daysToAdd) {
        let result = new Date(startDate);
        let added = 0;
        while (added < daysToAdd) {
          result.setDate(result.getDate() + 1);
          const day = result.getDay();
          if (day !== 0 && day !== 6) added++;
        }
        return result;
      }

      function addRow() {
        const tbody = document.getElementById("invoice-body");
        const rowNumber = tbody.rows.length + 1;
        const row = tbody.insertRow();

        for (let i = 0; i < 6; i++) {
          const cell = row.insertCell();
          const input = document.createElement("input");
          input.className = "form-control";
          input.type = "text";
          if (i === 0) input.value = rowNumber;
          if (i === 5) {
            input.classList.add("amount");
            input.onfocus = markManualAmount;
          }
          input.oninput = updateTotals;
          cell.appendChild(input);
        }

        const deleteCell = row.insertCell();
        deleteCell.innerHTML = `
  <button type="button" class="icon-button" onclick="deleteRow(this)" title="Delete row">
    <i class="bi bi-trash"></i>
  </button>
`;
      }

      function deleteRow(btn) {
        const row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
        updateTotals();
      }

      function updateTotals() {
        const tbody = document.getElementById("invoice-body");
        let subtotal = 0;

        for (let row of tbody.rows) {
          const inputs = row.getElementsByTagName("input");
          const qty = parseFloat(inputs[3].value) || 0;
          const rate = parseFloat(inputs[4].value) || 0;
          const amountCell = inputs[5];

          if (!amountCell.hasAttribute("manual")) {
            amountCell.value = (qty * rate).toFixed(2);
          }

          subtotal += parseFloat(amountCell.value) || 0;
        }

        document.getElementById("subtotal").innerText = subtotal.toFixed(2);

        const tax = parseFloat(document.getElementById("tax").textContent) || 0;
        const total = subtotal + (subtotal * tax) / 100;
        document.getElementById("total").innerText = total.toFixed(2);

        // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è Amount in EUR
        const currency = document
          .getElementById("currency")
          .textContent.trim()
          .split(" ")[0];

        const amountInEurEl = document.getElementById("amount_in_eur");

        if (currency === "$") {
          const exchangeRate = parseFloat(
            document.getElementById("exchange_rate").value
          );
          amountInEurEl.innerText =
            exchangeRate > 0 ? (total / exchangeRate).toFixed(2) : "0.00";
        } else {
          amountInEurEl.innerText = "";
        }
      }

      function markManualAmount(e) {
        e.target.setAttribute("manual", "true");
      }

      function submitForm() {
        const errors = [];

        // Test client-server communication
        google.script.run.testLogger("Test from client before invoice submit");

        const invoiceNumberEl = document.getElementById("invoice_number");
        const invoiceDateEl = document.getElementById("invoice_date");
        const projectNameEl = document.getElementById("project_name");

        const invoiceNumber = invoiceNumberEl.value.trim();
        const invoiceDate = invoiceDateEl.value.trim();
        const projectValue = projectNameEl.value.trim();

        [projectNameEl, invoiceNumberEl, invoiceDateEl].forEach((el) =>
          el.classList.remove("is-invalid")
        );

        if (!validProjectNames.includes(projectValue)) {
          errors.push("Project Name must be selected from the list.");
          projectNameEl.classList.add("is-invalid");
        }
        if (!invoiceNumber) {
          errors.push("Invoice Number is required.");
          invoiceNumberEl.classList.add("is-invalid");
        }
        if (!invoiceDate) {
          errors.push("Invoice Date is required.");
          invoiceDateEl.classList.add("is-invalid");
        }

        if (errors.length > 0) {
          showValidationError(errors);
          return;
        }

        // Check if project details are loaded
        if (
          !window.currentProjectDetails ||
          !window.currentProjectDetails.templateId
        ) {
          console.log("Project details not loaded, loading now...");
          // Load project details first
          google.script.run
            .withSuccessHandler(function (details) {
              window.currentProjectDetails = details;
              console.log("Project details loaded:", details);
              // Now submit the form with the loaded details
              submitFormWithData();
            })
            .withFailureHandler(function (error) {
              console.error("Failed to load project details:", error);
              alert("Failed to load project details. Please try again.");
              document.getElementById("generate-btn").disabled = false;
              document.getElementById("spinner").style.display = "none";
            })
            .getProjectDetails(projectValue);
          return;
        }

        // If project details are already loaded, submit directly
        submitFormWithData();
      }

      function submitFormWithData() {
        const projectValue = document
          .getElementById("project_name")
          .value.trim();

        const data = {
          projectName: projectValue,
          invoiceNumber: document.getElementById("invoice_number").value.trim(),
          clientName:
            mode === "edit"
              ? document.getElementById("client_name_input").value.trim()
              : document.getElementById("client_name").textContent.trim(),
          clientAddress:
            mode === "edit"
              ? document.getElementById("client_address_input").value.trim()
              : document.getElementById("client_address").textContent.trim(),
          clientNumber:
            mode === "edit"
              ? document.getElementById("client_number_input").value.trim()
              : document.getElementById("client_number").textContent.trim(),
          invoiceDate: document.getElementById("invoice_date").value.trim(),
          dueDate:
            mode === "edit"
              ? (document.getElementById("due_date_input").value || "").trim()
              : document.getElementById("due_date").textContent.trim(),
          tax: document.getElementById("tax").textContent.trim(),
          subtotal: document.getElementById("subtotal").innerText.trim(),
          total: document.getElementById("total").innerText.trim(),
          exchangeRate: document.getElementById("exchange_rate").value.trim(),
          currency: document
            .getElementById("currency")
            .textContent.trim()
            .split(" ")[0],
          amountInEUR: document
            .getElementById("amount_in_eur")
            .innerText.trim(),
          bankDetails1:
            mode === "edit"
              ? document.getElementById("bank_details_1_input").value.trim()
              : document.getElementById("bank_details_1").textContent.trim(),
          bankDetails2:
            mode === "edit"
              ? document.getElementById("bank_details_2_input").value.trim()
              : document.getElementById("bank_details_2").textContent.trim(),
          ourCompany:
            mode === "edit"
              ? document.getElementById("our_company_input").value.trim()
              : document.getElementById("our_company").textContent.trim(),

          comment: document.getElementById("comment").value.trim(),
          items: [],
          templateId: window.currentProjectDetails?.templateId || "",
          folderId: window.currentProjectDetails?.folderId || "",
        };

        const tbody = document.getElementById("invoice-body");
        for (let row of tbody.rows) {
          const inputs = row.getElementsByTagName("input");
          const rowData = Array.from(inputs).map((i) => i.value.trim());
          data.items.push(rowData);
        }

        console.log(
          "Data being sent to server:",
          JSON.stringify(data, null, 2)
        );

        // Enable spinner and disable button + form
        document.getElementById("generate-btn").disabled = true;
        document.getElementById("spinner").style.display = "inline-block";
        setFormInputsDisabled(true);
        // Hide comment placeholder while processing
        (function hideCommentPlaceholderWhileCreate() {
          const commentInputEl = document.getElementById("comment");
          const commentDisplayEl = document.getElementById("comment-display");
          if (commentInputEl && commentDisplayEl) {
            commentDisplayEl.textContent = commentInputEl.value.trim();
            commentDisplayEl.style.display = "block";
            commentInputEl.style.display = "none";
          }
        })();
        document.getElementById("result").innerHTML = "";

        google.script.run
          .withFailureHandler(function (error) {
            document.getElementById("spinner").style.display = "none";
            document.getElementById("generate-btn").disabled = false;
            setFormInputsDisabled(false);
            // Revert comment input visibility on error
            (function revertCommentOnCreateError() {
              const commentInputEl = document.getElementById("comment");
              const commentDisplayEl =
                document.getElementById("comment-display");
              if (commentInputEl && commentDisplayEl) {
                commentDisplayEl.style.display = "none";
                commentInputEl.style.display = "block";
              }
            })();
            alert(
              "An error occurred: " +
                error.message +
                "\n\nPlease check the browser console (View > Developer > JavaScript Console) for more details."
            );
            console.error("Server-side call failed:", error);
          })
          .withSuccessHandler(function (result) {
            document.getElementById("spinner").style.display = "none";
            document.getElementById("result").innerHTML = `
      <div class="alert alert-success mt-4">
        <strong>Invoice created!</strong><br>
        <a href="${result.docUrl}" class="btn btn-outline-secondary mt-2" target="_blank">Open Google Doc</a>
        <a href="${result.pdfUrl}" class="btn btn-outline-secondary mt-2" target="_blank">Open PDF</a>
      </div>
    `;

            // üîí Keep form disabled and hide generate button after success
            setFormInputsDisabled(true);
            document.getElementById("generate-btn").style.display = "none";
            // Hide copy buttons (if copy flow)
            const copyBtns = document.getElementById(
              "copy-bottom-btn-container"
            );
            if (copyBtns) copyBtns.style.display = "none";

            // Show comment as plaintext, hide input to avoid placeholder
            (function swapCommentToPlaintext() {
              const commentInputEl = document.getElementById("comment");
              const commentDisplayEl =
                document.getElementById("comment-display");
              if (commentInputEl && commentDisplayEl) {
                commentDisplayEl.textContent = commentInputEl.value.trim();
                commentDisplayEl.style.display = "block";
                commentInputEl.style.display = "none";
              }
            })();
          })
          .processForm(data);
      }

      window.addEventListener("DOMContentLoaded", function () {
        populateProjectNames();
        console.log("Loaded InvoiceGenerator (DOMContentLoaded):", {
          invoiceId,
          mode,
        });

        // Hide the bottom delete button by default
        document.getElementById("delete-bottom-btn-container").style.display =
          "none";

        if (invoiceId) {
          google.script.run
            .withSuccessHandler(function (data) {
              console.log("Loaded invoice data (DOMContentLoaded):", data);
              if (!data || !data.projectName) {
                console.error("Invalid invoice data received:", data);
                alert(
                  "Error loading invoice data. The invoice may have invalid data in the database."
                );
                window.location.href = "?page=InvoicesList";
                return;
              }
              if (["view", "delete"].includes(mode)) {
                renderSavedDataRaw(data);
              } else {
                fillInvoiceFormFromSavedData(data);
                // If copying, immediately clear client-derived fields to avoid showing saved values
                if (mode === "copy") {
                  const clearText = (id) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = "";
                  };
                  [
                    "client_name",
                    "client_address",
                    "client_number",
                    "our_company",
                    "bank_details_1",
                    "bank_details_2",
                    "tax",
                    "currency",
                    "due_date",
                  ].forEach(clearText);
                  // Ensure delete buttons exist for each row
                  try {
                    document
                      .querySelectorAll("#invoice-body tr")
                      .forEach((row, idx) => {
                        if (idx === 0) return; // first row is not deletable
                        let last = row.cells[row.cells.length - 1];
                        if (!last) return;
                        if (last.querySelector(".icon-button")) return;
                        last.innerHTML = `
    <button type="button" class="icon-button" onclick="deleteRow(this)" title="Delete row">
      <i class="bi bi-trash"></i>
    </button>`;
                      });
                  } catch (_) {}
                }
              }

              if (!["edit", "copy"].includes(mode)) {
                document.querySelectorAll("input, textarea").forEach((el) => {
                  el.disabled = true;
                });
              }
              document.getElementById("comment-display").textContent =
                data.comment || "";
              if (mode !== "copy") {
                document.getElementById("due_date").textContent = data.dueDate
                  ? formatDateDDMMYYYY(new Date(data.dueDate))
                  : "";
              } else {
                document.getElementById("due_date").textContent = "";
              }

              // Populate hidden edit inputs with existing values
              document.getElementById("client_name_input").value =
                data.clientName || "";
              document.getElementById("client_address_input").value =
                data.clientAddress || "";
              document.getElementById("client_number_input").value =
                data.clientNumber || "";
              document.getElementById("our_company_input").value =
                data.ourCompany || "";
              document.getElementById("bank_details_1_input").value =
                data.bankDetails1 || "";
              document.getElementById("bank_details_2_input").value =
                data.bankDetails2 || "";
              document.getElementById("due_date_input").value = formatInputDate(
                data.dueDate || ""
              );
            })
            .getInvoiceDataById(invoiceId);

          // Set up the page based on mode
          if (mode === "delete") {
            document.getElementById("page-title").textContent =
              "Invoice - Delete";
            document.getElementById(
              "delete-bottom-btn-container"
            ).style.display = "block";
            const editBtns = document.getElementById(
              "edit-bottom-btn-container"
            );
            if (editBtns) editBtns.style.display = "none";

            // Add event handler for delete button
            document
              .getElementById("delete-bottom-btn")
              .addEventListener("click", function () {
                // Show single spinner (consistent with edit/create)
                const bottomSpin = document.getElementById(
                  "delete-bottom-spinner"
                );
                if (bottomSpin) bottomSpin.style.display = "inline-block";

                // Disable button
                this.disabled = true;

                // Call delete function
                google.script.run
                  .withSuccessHandler(function (result) {
                    if (result.success) {
                      // Show success modal and stop spinner
                      const bottomSpinDone = document.getElementById(
                        "delete-bottom-spinner"
                      );
                      if (bottomSpinDone) bottomSpinDone.style.display = "none";
                      const spinnerTopDone =
                        document.getElementById("delete-spinner");
                      if (spinnerTopDone) spinnerTopDone.style.display = "none";
                      // Show success modal
                      const modal = new bootstrap.Modal(
                        document.getElementById("deleteSuccessModal")
                      );
                      modal.show();

                      // Redirect when modal is closed
                      document
                        .getElementById("deleteSuccessModal")
                        .addEventListener(
                          "hidden.bs.modal",
                          function () {
                            safeNavigateToInvoicesList();
                          },
                          { once: true }
                        );
                    } else {
                      alert(
                        "Error deleting invoice: " +
                          (result.message || "Unknown error")
                      );
                      // Re-enable button
                      document.getElementById(
                        "delete-bottom-btn"
                      ).disabled = false;
                      const bottomSpin2 = document.getElementById(
                        "delete-bottom-spinner"
                      );
                      if (bottomSpin2) bottomSpin2.style.display = "none";
                    }
                  })
                  .withFailureHandler(function (error) {
                    alert("Error deleting invoice: " + error.message);
                    // Re-enable button
                    document.getElementById(
                      "delete-bottom-btn"
                    ).disabled = false;
                    const bottomSpin3 = document.getElementById(
                      "delete-bottom-spinner"
                    );
                    if (bottomSpin3) bottomSpin3.style.display = "none";
                  })
                  .deleteInvoiceById(invoiceId);
              });
          } else if (mode === "view") {
            document.getElementById("page-title").textContent =
              "Invoice - View";
            document.getElementById(
              "delete-bottom-btn-container"
            ).style.display = "none";
            const editBtns = document.getElementById(
              "edit-bottom-btn-container"
            );
            if (editBtns) editBtns.style.display = "none";
          } else if (mode === "edit") {
            document.getElementById("page-title").textContent =
              "Invoice - Edit";
            document.getElementById(
              "delete-bottom-btn-container"
            ).style.display = "none";
            const editBtns = document.getElementById(
              "edit-bottom-btn-container"
            );
            if (editBtns) editBtns.style.display = "block";

            // Ensure templateId is available for the selected project in edit mode
            (function ensureTemplateForEdit() {
              try {
                const projectValue = (
                  document.getElementById("project_name").value || ""
                ).trim();
                if (projectValue) {
                  google.script.run
                    .withSuccessHandler(function (details) {
                      window.currentProjectDetails = details || {};
                    })
                    .withFailureHandler(function () {})
                    .getProjectDetails(projectValue);
                }
              } catch (_) {}
            })();
            // Wire up Exit without saving ‚Üí back to list
            const exitBtn = document.getElementById("save-without-changes-btn");
            if (exitBtn) {
              exitBtn.addEventListener("click", function () {
                safeNavigateToInvoicesList();
              });
            }
            // Save changes: collect current form data and send to backend
            const saveBtn = document.getElementById("save-with-changes-btn");
            if (saveBtn) {
              saveBtn.addEventListener("click", function () {
                try {
                  // UI: disable buttons and show spinner
                  saveBtn.disabled = true;
                  const exitBtnEl = document.getElementById(
                    "save-without-changes-btn"
                  );
                  if (exitBtnEl) exitBtnEl.disabled = true;
                  const editSpin = document.getElementById("edit-spinner");
                  if (editSpin) editSpin.style.display = "inline-block";
                  setFormInputsDisabled(true);
                  // Ensure Currency display becomes non-editable immediately
                  const currencyEl = document.getElementById("currency");
                  if (currencyEl) {
                    currencyEl.contentEditable = "false";
                    currencyEl.classList.remove("form-control");
                    currencyEl.classList.add("form-control-plaintext");
                  }
                  // Hide comment placeholder while processing (edit)
                  const commentInputProc = document.getElementById("comment");
                  const commentDisplayProc =
                    document.getElementById("comment-display");
                  if (commentInputProc && commentDisplayProc) {
                    commentDisplayProc.textContent =
                      commentInputProc.value.trim();
                    commentDisplayProc.style.display = "block";
                    commentInputProc.style.display = "none";
                  }

                  const payload = buildCurrentFormDataForSave();
                  google.script.run
                    .withSuccessHandler(function (res) {
                      if (!res || !res.success) {
                        alert(
                          "Failed to update invoice: " +
                            (res && res.message ? res.message : "Unknown error")
                        );
                        return;
                      }
                      // Render links like after creation
                      document.getElementById("result").innerHTML = `
      <div class="alert alert-success mt-4">
        <strong>Invoice updated!</strong><br>
        <a href="${res.docUrl}" class="btn btn-outline-secondary mt-2" target="_blank">Open Google Doc</a>
        <a href="${res.pdfUrl}" class="btn btn-outline-secondary mt-2" target="_blank">Open PDF</a>
      </div>
    `;
                      // Hide edit action buttons after successful update and keep form disabled
                      const editBtnsAfter = document.getElementById(
                        "edit-bottom-btn-container"
                      );
                      if (editBtnsAfter) editBtnsAfter.style.display = "none";
                      // Ensure currency becomes non-editable and shown as plaintext
                      (function ensureCurrencyPlain() {
                        const currencyEl = document.getElementById("currency");
                        if (currencyEl) {
                          currencyEl.contentEditable = "false";
                          currencyEl.classList.remove("form-control");
                          currencyEl.classList.add("form-control-plaintext");
                        }
                      })();
                      // Swap comment input to plaintext to avoid placeholder
                      (function swapCommentToPlaintextAfterEdit() {
                        const commentInputEl =
                          document.getElementById("comment");
                        const commentDisplayEl =
                          document.getElementById("comment-display");
                        if (commentInputEl && commentDisplayEl) {
                          commentDisplayEl.textContent =
                            commentInputEl.value.trim();
                          commentDisplayEl.style.display = "block";
                          commentInputEl.style.display = "none";
                        }
                      })();
                      // Hide add-row button after save
                      const addRowBtnHide =
                        document.getElementById("add-row-btn");
                      if (addRowBtnHide) addRowBtnHide.style.display = "none";
                    })
                    .withFailureHandler(function (err) {
                      alert("Error updating invoice: " + err.message);
                      // Re-enable on error
                      saveBtn.disabled = false;
                      const exitBtnEl2 = document.getElementById(
                        "save-without-changes-btn"
                      );
                      if (exitBtnEl2) exitBtnEl2.disabled = false;
                      const editSpin2 = document.getElementById("edit-spinner");
                      if (editSpin2) editSpin2.style.display = "none";
                      setFormInputsDisabled(false);
                      // Revert comment visibility on error
                      const commentInputErr =
                        document.getElementById("comment");
                      const commentDisplayErr =
                        document.getElementById("comment-display");
                      if (commentInputErr && commentDisplayErr) {
                        commentDisplayErr.style.display = "none";
                        commentInputErr.style.display = "block";
                      }
                    })
                    .updateInvoiceById(invoiceId, payload);
                } catch (e) {
                  console.error(e);
                  alert("Failed to collect form data: " + e.message);
                  // Re-enable on exception
                  saveBtn.disabled = false;
                  const exitBtnEl3 = document.getElementById(
                    "save-without-changes-btn"
                  );
                  if (exitBtnEl3) exitBtnEl3.disabled = false;
                  const editSpin3 = document.getElementById("edit-spinner");
                  if (editSpin3) editSpin3.style.display = "none";
                  setFormInputsDisabled(false);
                  // Revert comment visibility on exception
                  const commentInputEx = document.getElementById("comment");
                  const commentDisplayEx =
                    document.getElementById("comment-display");
                  if (commentInputEx && commentDisplayEx) {
                    commentDisplayEx.style.display = "none";
                    commentInputEx.style.display = "block";
                  }
                }
              });
            }
          } else if (mode === "copy") {
            document.getElementById("page-title").textContent =
              "Invoice - Copy";
            document.getElementById(
              "delete-bottom-btn-container"
            ).style.display = "none";
            const editBtnsHide = document.getElementById(
              "edit-bottom-btn-container"
            );
            if (editBtnsHide) editBtnsHide.style.display = "none";
            const copyBtns = document.getElementById(
              "copy-bottom-btn-container"
            );
            if (copyBtns) copyBtns.style.display = "block";

            // Wire up Copy buttons
            const copyCancel = document.getElementById("copy-cancel-btn");
            if (copyCancel) {
              copyCancel.addEventListener("click", function () {
                safeNavigateToInvoicesList();
              });
            }
            const copyCreate = document.getElementById("copy-create-new-btn");
            if (copyCreate) {
              copyCreate.addEventListener("click", function () {
                try {
                  // Disable to prevent double submit
                  copyCreate.disabled = true;
                  const projectVal = document
                    .getElementById("project_name")
                    .value.trim();
                  // If we already cached details for this project with templateId, reuse; else fetch
                  if (
                    window.currentProjectDetails &&
                    window.currentProjectDetails.templateId &&
                    window.currentProjectNameCached === projectVal
                  ) {
                    submitFormWithData();
                  } else {
                    google.script.run
                      .withSuccessHandler(function (details) {
                        try {
                          window.currentProjectDetails = details || {};
                          window.currentProjectNameCached = projectVal;
                          fillProjectDetails(details || {});
                          submitFormWithData();
                        } catch (e) {
                          alert("Failed to start creation: " + e.message);
                          copyCreate.disabled = false;
                        }
                      })
                      .withFailureHandler(function (err) {
                        alert("Failed to load project details: " + err.message);
                        copyCreate.disabled = false;
                      })
                      .getProjectDetails(projectVal);
                  }
                } catch (e) {
                  alert("Failed to create from copy: " + e.message);
                  copyCreate.disabled = false;
                }
              });
            }

            // In copy mode, enable inputs for editable fields and refresh client-derived details
            const inputsToEnable = ["invoice_number", "invoice_date"];
            inputsToEnable.forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.disabled = false;
            });
            // Table inputs
            document.querySelectorAll("#invoice-body input").forEach((el) => {
              el.disabled = false;
            });
            // Allow exchange rate editing only for USD
            const exchInput = document.getElementById("exchange_rate");
            if (exchInput) exchInput.disabled = false;
            // Comment input visible and enabled
            (function showCommentForCopy() {
              const commentInputEl = document.getElementById("comment");
              const commentDisplayEl =
                document.getElementById("comment-display");
              if (commentInputEl && commentDisplayEl) {
                commentDisplayEl.style.display = "none";
                commentInputEl.style.display = "block";
                commentInputEl.disabled = false;
              }
            })();
            // Pull client-derived details from Lists as in create
            (function refreshFromListsForCopy() {
              const selectedProjectCopy = document
                .getElementById("project_name")
                .value.trim();
              if (!selectedProjectCopy) return;
              // Clear client-derived fields to avoid showing old invoice data
              const clearText = (id) => {
                const el = document.getElementById(id);
                if (el) el.textContent = "";
              };
              [
                "client_name",
                "client_address",
                "client_number",
                "our_company",
                "bank_details_1",
                "bank_details_2",
                "tax",
                "currency",
                "due_date",
              ].forEach(clearText);
              google.script.run
                .withSuccessHandler(function (details) {
                  // Overwrite UI with Lists values (like create)
                  fillProjectDetails(details || {});
                  window.currentProjectDetails = details || {};
                  window.currentProjectNameCached = selectedProjectCopy;
                  // Recompute due date immediately
                  try {
                    const invoiceDateVal =
                      document.getElementById("invoice_date").value;
                    let due = null;
                    if (invoiceDateVal) {
                      let baseDate = new Date(invoiceDateVal);
                      if ((details && details.dayType) === "WD") {
                        due = addWorkingDays(
                          baseDate,
                          parseInt(details.paymentDelay) || 0
                        );
                      } else {
                        due = new Date(baseDate);
                        due.setDate(
                          due.getDate() + (parseInt(details.paymentDelay) || 0)
                        );
                      }
                    }
                    document.getElementById("due_date").textContent = due
                      ? formatDateDDMMYYYY(due)
                      : "";
                  } catch (_) {}
                })
                .getProjectDetails(selectedProjectCopy);
            })();
          } else {
            document.getElementById("page-title").textContent =
              "Invoice - View";
            document.getElementById(
              "delete-bottom-btn-container"
            ).style.display = "none";
            const editBtns = document.getElementById(
              "edit-bottom-btn-container"
            );
            if (editBtns) editBtns.style.display = "none";
            const copyBtnsHide = document.getElementById(
              "copy-bottom-btn-container"
            );
            if (copyBtnsHide) copyBtnsHide.style.display = "none";
          }
          document.getElementById("back-to-list").style.display = "block";
          document.getElementById("generate-btn").style.display = "none";
          const newInvoiceBtn = document.getElementById("new-invoice-btn");
          if (newInvoiceBtn) newInvoiceBtn.style.display = "none";

          const addRowBtn = document.getElementById("add-row-btn");
          if (addRowBtn)
            addRowBtn.style.display = ["edit", "copy"].includes(mode)
              ? "inline-block"
              : "none";

          // Keep Project Name non-editable in edit mode
          if (mode === "edit") {
            const projectNameEl = document.getElementById("project_name");
            if (projectNameEl) projectNameEl.disabled = true;
          }

          const commentInput = document.getElementById("comment");
          const commentDisplay = document.getElementById("comment-display");
          const toggleEditField = (plainId, inputId) => {
            const plain = document.getElementById(plainId);
            const input = document.getElementById(inputId);
            if (!plain || !input) return;
            if (mode === "edit") {
              plain.style.display = "none";
              input.style.display = "block";
            } else {
              plain.style.display = "block";
              input.style.display = "none";
            }
          };

          if (mode === "edit") {
            if (commentInput) commentInput.style.display = "block";
            if (commentDisplay) commentDisplay.style.display = "none";
            toggleEditField("client_name", "client_name_input");
            toggleEditField("client_address", "client_address_input");
            toggleEditField("client_number", "client_number_input");
            toggleEditField("our_company", "our_company_input");
            toggleEditField("bank_details_1", "bank_details_1_input");
            toggleEditField("bank_details_2", "bank_details_2_input");
            toggleEditField("due_date", "due_date_input");
          } else {
            if (commentInput) commentInput.style.display = "none";
            if (commentDisplay) commentDisplay.style.display = "block";
            toggleEditField("client_name", "client_name_input");
            toggleEditField("client_address", "client_address_input");
            toggleEditField("client_number", "client_number_input");
            toggleEditField("our_company", "our_company_input");
            toggleEditField("bank_details_1", "bank_details_1_input");
            toggleEditField("bank_details_2", "bank_details_2_input");
            toggleEditField("due_date", "due_date_input");
          }

          // Make plaintext fields editable in edit mode
          if (mode === "edit") {
            const makeEditable = (id) => {
              const el = document.getElementById(id);
              if (el) {
                el.contentEditable = "true";
                el.classList.remove("form-control-plaintext");
                el.classList.add("form-control");
              }
            };
            [
              "client_name",
              "client_address",
              "client_number",
              "our_company",
              "bank_details_1",
              "bank_details_2",
              "due_date",
            ].forEach(makeEditable);
          }
        } else {
          document.getElementById("page-title").textContent = "Create invoice";
          const editBtns = document.getElementById("edit-bottom-btn-container");
          if (editBtns) editBtns.style.display = "none";
          // Optionally clear fields here
          console.log("No invoiceId found in URL, showing blank form.");
          const selectedProject = document
            .getElementById("project_name")
            .value.trim();
          if (mode === "create" && selectedProject) {
            google.script.run
              .withSuccessHandler(fillProjectDetails)
              .getProjectDetails(selectedProject);
          }
        }
      });

      function showValidationError(messages) {
        const result = document.getElementById("result");
        result.innerHTML = `
          <div class="alert alert-danger">
            <strong>Please fill out the following fields:</strong>
            <ul>${messages.map((msg) => `<li>${msg}</li>`).join("")}</ul>
          </div>
        `;
        result.scrollIntoView({ behavior: "smooth" });
      }

      if (["create", "edit"].includes(mode)) {
        ["project_name", "invoice_number", "invoice_date"].forEach((id) => {
          document.getElementById(id).addEventListener("input", () => {
            document.getElementById(id).classList.remove("is-invalid");
            document.getElementById("result").innerHTML = "";
          });
        });
      }

      function showModalDialog(message, onConfirm) {
        document.getElementById("confirmModalText").textContent = message;

        const modal = new bootstrap.Modal(
          document.getElementById("confirmModal")
        );
        modal.show();

        const okButton = document.getElementById("confirmModalOK");
        const cloned = okButton.cloneNode(true); // to remove old handlers
        okButton.parentNode.replaceChild(cloned, okButton);

        cloned.addEventListener("click", function () {
          modal.hide();
          onConfirm();
        });
      }

      function createNewInvoice() {
        const isFormDisabled = document.getElementById("project_name").disabled;

        if (isFormDisabled) {
          resetForm(); // –ø—Ä–æ—Å—Ç–æ –æ—á–∏—Å—Ç–∏—Ç—å
          return;
        }

        const hasFilledFields = [...document.querySelectorAll("input")].some(
          (el) => el.type !== "hidden" && el.value.trim() !== ""
        );

        if (hasFilledFields) {
          showModalDialog(
            "Are you sure? Your entered data will not be saved.",
            () => resetForm()
          );
        } else {
          resetForm();
        }
      }

      function resetForm() {
        document.querySelectorAll("input, textarea").forEach((el) => {
          el.value = "";
          el.disabled = false;
        });

        document
          .querySelectorAll("p.form-control-plaintext, pre")
          .forEach((el) => {
            el.textContent = "";
          });

        document.getElementById("invoice-body").innerHTML = "";
        addRow();

        document.getElementById("result").innerHTML = "";
        document.getElementById("generate-btn").disabled = false;
        document.getElementById("spinner").style.display = "none";

        populateProjectNames();
      }
    </script>
    <!-- Custom modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Action</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p id="confirmModalText">Placeholder message</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="confirmModalOK">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
